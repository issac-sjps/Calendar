<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–°èŠåœ‹å° å­¸æ ¡è¡Œäº‹æ›†</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@700;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#f0f4f8;--surface:#fff;--surface2:#f8fafc;--border:#e2e8f0;
  --text:#1a202c;--text2:#4a5568;--text3:#a0aec0;
  --shadow:0 1px 3px rgba(0,0,0,.07),0 4px 14px rgba(0,0,0,.05);
  --shadow-lg:0 8px 32px rgba(0,0,0,.13);
  --æ•™å‹™è™•:#3b82f6;--æ•™å‹™è™•-light:#eff6ff;--æ•™å‹™è™•-text:#1d4ed8;
  --å­¸å‹™è™•:#10b981;--å­¸å‹™è™•-light:#f0fdf4;--å­¸å‹™è™•-text:#065f46;
  --è¼”å°è™•:#f59e0b;--è¼”å°è™•-light:#fffbeb;--è¼”å°è™•-text:#92400e;
  --ç¸½å‹™è™•:#8b5cf6;--ç¸½å‹™è™•-light:#f5f3ff;--ç¸½å‹™è™•-text:#5b21b6;
  --holiday-bg:#fff5f5;--weekend-bg:#fff8f8;
}
body{font-family:'Noto Sans TC',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;}

/* â”€â”€ Header â”€â”€ */
header{
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:0 1rem;display:flex;align-items:center;
  justify-content:space-between;height:56px;
  position:sticky;top:0;z-index:100;
  box-shadow:0 1px 6px rgba(0,0,0,.06);flex-shrink:0;gap:0.5rem;
}
.header-left{display:flex;align-items:center;gap:0.6rem;flex-shrink:0;}
.school-badge{background:#1a202c;color:#fff;font-family:'Noto Serif TC',serif;font-weight:900;font-size:0.82rem;padding:0.28rem 0.55rem;letter-spacing:.04em;white-space:nowrap;}
.school-title{font-family:'Noto Serif TC',serif;font-weight:700;font-size:0.95rem;white-space:nowrap;}
.header-date{font-size:0.8rem;color:var(--text3);font-weight:500;white-space:nowrap;}

/* Marquee ticker */
.header-ticker{
  flex:1;overflow:hidden;height:56px;display:flex;align-items:center;
  padding:0 0.75rem;min-width:0;
}
.ticker-inner{
  display:flex;align-items:center;gap:1.5rem;
  white-space:nowrap;animation:ticker 20s linear infinite;
}
.ticker-inner:hover{animation-play-state:paused;}
@keyframes ticker{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
.ticker-item{font-size:0.78rem;color:var(--text2);display:inline-flex;align-items:center;gap:0.4rem;}
.ticker-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.ticker-empty{font-size:0.78rem;color:var(--text3);}

.header-right{display:flex;align-items:center;gap:0.55rem;flex-shrink:0;}
#user-info{font-size:0.78rem;color:var(--text2);display:none;align-items:center;gap:0.4rem;}
.btn-sm{padding:0.35rem 0.85rem;border-radius:6px;font-family:'Noto Sans TC',sans-serif;font-size:0.78rem;font-weight:500;cursor:pointer;border:none;transition:all .14s;}
.btn-primary{background:#1a202c;color:#fff;}.btn-primary:hover{background:#2d3748;}
.btn-ghost{background:none;border:1px solid var(--border)!important;color:var(--text2);}
.btn-ghost:hover{border-color:#94a3b8!important;color:var(--text);}
#btn-add-header,#btn-batch{display:none;}
#btn-add-header{background:#1a202c;color:#fff;padding:0.35rem 0.9rem;border-radius:6px;font-family:'Noto Sans TC',sans-serif;font-size:0.78rem;font-weight:500;cursor:pointer;border:none;transition:background .14s;}
#btn-add-header:hover{background:#2d3748;}
#btn-batch{padding:0.35rem 0.9rem;border-radius:6px;font-family:'Noto Sans TC',sans-serif;font-size:0.78rem;font-weight:500;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text2);transition:all .14s;}
#btn-batch:hover{background:var(--bg);}

/* â”€â”€ Location Filter Bar â”€â”€ */
.location-bar{display:none;}
.loc-label{font-size:0.82rem;font-weight:600;color:var(--text2);margin-right:0.2rem;white-space:nowrap;}

/* Location dot colors */
.loc-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:3px;flex-shrink:0;}

/* â”€â”€ Body â”€â”€ */
.body-wrap{display:flex;flex:1;min-height:0;overflow:hidden;}

/* â”€â”€ Sidebar â”€â”€ */
.sidebar{
  width:110px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);
  padding:0.85rem 0.65rem;display:flex;flex-direction:column;gap:0.4rem;overflow-y:auto;
}
.sidebar-label{font-size:0.72rem;font-weight:700;color:var(--text3);letter-spacing:.06em;text-transform:uppercase;margin-bottom:0.1rem;padding-left:0.2rem;}
.sidebar-loc-btn{
  width:100%;padding:0.3rem 0.5rem;border-radius:6px;
  border:1px solid transparent;background:none;
  font-family:'Noto Sans TC',sans-serif;font-size:0.73rem;font-weight:500;
  cursor:pointer;transition:all .13s;text-align:left;
  display:flex;align-items:center;gap:0.35rem;color:var(--text2);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.sidebar-loc-btn:hover{background:var(--surface2);color:var(--text);}
.sidebar-loc-btn.active{background:#1a202c;color:#fff;}
.dept-btn{
  width:100%;padding:0.5rem 0.6rem;border-radius:8px;
  border:1.5px solid var(--border);background:none;
  font-family:'Noto Sans TC',sans-serif;font-size:0.82rem;font-weight:500;
  cursor:pointer;transition:all .14s;text-align:left;
  display:flex;align-items:center;gap:0.4rem;color:var(--text2);
}
.d-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0;}
.dept-btn:hover{border-color:#94a3b8;color:var(--text);background:var(--surface2);}
.dept-btn.active{border-color:transparent;color:#fff;}
.dept-btn.active .d-dot{background:rgba(255,255,255,.55)!important;}
.dept-btn.active-all{background:#1a202c;border-color:#1a202c;}
.dept-btn.active-æ•™å‹™è™•{background:var(--æ•™å‹™è™•);border-color:var(--æ•™å‹™è™•);}
.dept-btn.active-å­¸å‹™è™•{background:var(--å­¸å‹™è™•);border-color:var(--å­¸å‹™è™•);}
.dept-btn.active-è¼”å°è™•{background:var(--è¼”å°è™•);border-color:var(--è¼”å°è™•);}
.dept-btn.active-ç¸½å‹™è™•{background:var(--ç¸½å‹™è™•);border-color:var(--ç¸½å‹™è™•);}
.sidebar-divider{height:1px;background:var(--border);margin:0.15rem 0;}

/* â”€â”€ Calendar wrap â”€â”€ */
.cal-wrap{flex:1;padding:1.1rem;min-width:0;overflow-y:auto;display:flex;flex-direction:column;gap:0.75rem;}

/* Month/year quick nav */
.quick-nav{
  display:flex;align-items:center;gap:0.35rem;flex-wrap:wrap;
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:0.55rem 0.85rem;
}
.qnav-label{font-size:0.75rem;font-weight:600;color:var(--text3);margin-right:0.15rem;}
.qnav-btn{
  padding:0.22rem 0.55rem;border-radius:5px;border:1px solid var(--border);
  background:none;font-family:'Noto Sans TC',sans-serif;font-size:0.75rem;font-weight:500;
  cursor:pointer;color:var(--text2);transition:all .13s;
}
.qnav-btn:hover{background:var(--bg);border-color:#94a3b8;}
.qnav-btn.active{background:#1a202c;border-color:#1a202c;color:#fff;}
.qnav-sep{width:1px;height:16px;background:var(--border);margin:0 0.25rem;}
.year-select{padding:0.22rem 0.45rem;border:1px solid var(--border);border-radius:5px;font-family:'Noto Sans TC',sans-serif;font-size:0.75rem;color:var(--text);outline:none;cursor:pointer;}

/* Location filter bar buttons */
.loc-bar-btn{
  padding:0.2rem 0.6rem;border-radius:999px;border:1.5px solid var(--border);
  background:none;font-family:'Noto Sans TC',sans-serif;font-size:0.74rem;font-weight:500;
  cursor:pointer;color:var(--text2);transition:all .13s;white-space:nowrap;
  display:inline-flex;align-items:center;gap:3px;
}
.loc-bar-btn:hover{border-color:#94a3b8;color:var(--text);}
.loc-bar-btn.active{background:#1a202c;border-color:#1a202c;color:#fff;}
.loc-bar-btn.active .loc-dot{opacity:0.6;}
#loc-bar{display:flex;}

@media(max-width:640px){
  #loc-bar{display:none!important;}
}

/* Cal nav */
.cal-nav{display:flex;align-items:center;justify-content:space-between;}
.cal-nav-center{display:flex;align-items:center;gap:0.65rem;}
.cal-month{font-family:'Noto Serif TC',serif;font-size:1.25rem;font-weight:700;min-width:140px;text-align:center;}
.icon-btn{width:32px;height:32px;border-radius:7px;border:1px solid var(--border);background:var(--surface);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--text2);transition:all .13s;}
.icon-btn:hover{background:var(--bg);border-color:#94a3b8;color:var(--text);}
.today-btn{padding:0.3rem 0.75rem;border-radius:6px;border:1px solid var(--border);background:var(--surface);font-family:'Noto Sans TC',sans-serif;font-size:0.78rem;cursor:pointer;color:var(--text2);transition:all .13s;}
.today-btn:hover{background:var(--bg);color:var(--text);}
.view-toggle{display:flex;border:1px solid var(--border);border-radius:7px;overflow:hidden;}
.view-toggle button{padding:0.28rem 0.7rem;border:none;background:var(--surface);color:var(--text2);font-family:'Noto Sans TC',sans-serif;font-size:0.75rem;font-weight:500;cursor:pointer;transition:all .13s;}
.view-toggle button:last-child{border-left:1px solid var(--border);}
.view-toggle button.active{background:#1a202c;color:#fff;}

/* â”€â”€ Calendar Grid â”€â”€ */
.cal-grid{background:var(--surface);border-radius:10px;border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden;}
.cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--border);background:var(--surface2);}
.cal-weekday{padding:0.5rem;text-align:center;font-size:0.75rem;font-weight:600;color:var(--text3);}
.cal-weekday:first-child{color:#ef4444;}
.cal-weekday:last-child{color:#3b82f6;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);}

.cal-day{
  height:120px;
  border-right:1px solid var(--border);border-bottom:1px solid var(--border);
  padding:0.28rem;position:relative;transition:background .1s;cursor:pointer;
  overflow:hidden;display:flex;flex-direction:column;
}
.cal-day:nth-child(7n){border-right:none;}
.cal-day:nth-last-child(-n+7){border-bottom:none;}
.cal-day.other-month{background:var(--surface2);}
.cal-day.other-month .day-num{color:var(--text3);}
.cal-day.today .day-num{background:#1a202c;color:#fff;border-radius:50%;}
.cal-day.weekend{background:var(--weekend-bg);}
.cal-day.holiday{background:var(--holiday-bg);}
.cal-day.other-month.weekend,.cal-day.other-month.holiday{background:var(--surface2);}
.cal-day:not(.other-month):hover{background:#f0f7ff;}
.cal-day.today:hover .day-num{background:#2d3748;}

.day-num{font-size:0.8rem;font-weight:600;width:24px;height:24px;display:flex;align-items:center;justify-content:center;margin-bottom:0.15rem;border-radius:50%;transition:background .1s;flex-shrink:0;}
.day-num-wrap{display:flex;align-items:center;gap:0.25rem;margin-bottom:0.12rem;flex-shrink:0;}
.cal-day.sunday .day-num{color:#ef4444;}
.cal-day.saturday .day-num{color:#3b82f6;}
.holiday-name{font-size:0.58rem;color:#ef4444;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60px;}

.day-events{display:flex;flex-direction:column;gap:1px;flex:1;overflow:hidden;min-height:0;}
.event-chip{
  border-radius:3px;padding:2px 5px;font-size:0.63rem;font-weight:500;
  cursor:pointer;transition:filter .1s;line-height:1.45;
  display:flex;flex-direction:row;align-items:center;gap:3px;
  overflow:hidden;white-space:nowrap;flex-shrink:0;
}
.event-chip:hover{filter:brightness(.88);}
.chip-time{font-size:0.55rem;opacity:0.65;font-weight:400;flex-shrink:0;white-space:nowrap;margin-left:2px;}
.chip-title{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0;font-weight:500;}
.chip-loc{font-size:0.56rem;opacity:0.75;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60px;margin-left:1px;}
.chip-conflict{position:relative;}
.chip-conflict::after{content:'âš ';position:absolute;top:-3px;right:-3px;font-size:0.6rem;background:#fff;border-radius:50%;line-height:1;padding:0 1px;}
.more-chip{font-size:0.62rem;color:var(--text3);padding:1px 4px;cursor:pointer;flex-shrink:0;margin-top:auto;}

/* Dept / location dot colors */
.bg-æ•™å‹™è™•{background:var(--æ•™å‹™è™•);color:#fff;}
.bg-å­¸å‹™è™•{background:var(--å­¸å‹™è™•);color:#fff;}
.bg-è¼”å°è™•{background:var(--è¼”å°è™•);color:#fff;}
.bg-ç¸½å‹™è™•{background:var(--ç¸½å‹™è™•);color:#fff;}
.soft-æ•™å‹™è™•{background:var(--æ•™å‹™è™•-light);color:var(--æ•™å‹™è™•-text);}
.soft-å­¸å‹™è™•{background:var(--å­¸å‹™è™•-light);color:var(--å­¸å‹™è™•-text);}
.soft-è¼”å°è™•{background:var(--è¼”å°è™•-light);color:var(--è¼”å°è™•-text);}
.soft-ç¸½å‹™è™•{background:var(--ç¸½å‹™è™•-light);color:var(--ç¸½å‹™è™•-text);}
.dot-æ•™å‹™è™•{background:var(--æ•™å‹™è™•);}
.dot-å­¸å‹™è™•{background:var(--å­¸å‹™è™•);}
.dot-è¼”å°è™•{background:var(--è¼”å°è™•);}
.dot-ç¸½å‹™è™•{background:var(--ç¸½å‹™è™•);}

/* Location dot colors (rainbow for variety) */
.ldot-0{background:#ef4444;}
.ldot-1{background:#f97316;}
.ldot-2{background:#eab308;}
.ldot-3{background:#22c55e;}
.ldot-4{background:#06b6d4;}
.ldot-5{background:#3b82f6;}
.ldot-6{background:#8b5cf6;}
.ldot-7{background:#ec4899;}
.ldot-8{background:#14b8a6;}
.ldot-9{background:#f59e0b;}
.ldot-10{background:#10b981;}
.ldot-11{background:#6366f1;}
.ldot-12{background:#84cc16;}
.ldot-13{background:#f43f5e;}

/* â”€â”€ Week view â”€â”€ */
.week-4col{display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem;}
.week-dept-col{background:var(--surface);border-radius:10px;border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden;}
.week-dept-header{padding:0.55rem 0.75rem;font-size:0.82rem;font-weight:700;display:flex;align-items:center;gap:0.4rem;}
.week-dept-body{padding:0.5rem;display:flex;flex-direction:column;gap:0;}
.week-day-row{border-bottom:1px solid var(--border);padding:0.4rem 0.25rem;cursor:pointer;transition:background .1s;}
.week-day-row:last-child{border-bottom:none;}
.week-day-row:hover{background:var(--surface2);}
.week-day-row.is-today{background:#eff6ff;}
.week-day-row.weekend-row{background:var(--weekend-bg);}
.week-day-row.holiday-row{background:var(--holiday-bg);}
.week-date-line{display:flex;align-items:center;gap:0.35rem;margin-bottom:0.2rem;}
.week-day-num{font-size:0.85rem;font-weight:700;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%;flex-shrink:0;}
.week-day-row.is-today .week-day-num{background:#1a202c;color:#fff;}
.week-dow{font-size:0.68rem;color:var(--text3);}
.week-holiday-name{font-size:0.62rem;color:#ef4444;font-weight:600;}
.week-events{display:flex;flex-direction:column;gap:2px;padding-left:0.25rem;}
.week-ev-pill{
  padding:0.2rem 0.45rem;border-radius:4px;font-size:0.72rem;font-weight:500;
  cursor:pointer;transition:filter .1s;position:relative;
}
.week-ev-pill:hover{filter:brightness(.88);}
.week-ev-time{font-size:0.62rem;opacity:.85;}
.week-ev-loc{font-size:0.62rem;opacity:.8;}
.week-no-ev{font-size:0.7rem;color:var(--text3);padding:0.15rem 0.25rem;}

/* â”€â”€ Modals â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:200;padding:1rem;backdrop-filter:blur(3px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:14px;box-shadow:var(--shadow-lg);width:100%;max-width:480px;animation:mIn .2s cubic-bezier(.16,1,.3,1);overflow:hidden;}
@keyframes mIn{from{opacity:0;transform:scale(.94) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-header{padding:1.1rem 1.4rem 0.9rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.modal-header h3{font-size:0.95rem;font-weight:700;}
.modal-close{width:26px;height:26px;border-radius:5px;border:none;background:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.9rem;color:var(--text2);transition:background .1s;}
.modal-close:hover{background:var(--border);}
.modal-body{padding:1.1rem 1.4rem;max-height:68vh;overflow-y:auto;}
.modal-footer{padding:0.9rem 1.4rem;border-top:1px solid var(--border);display:flex;align-items:center;gap:0.45rem;}
.form-group{margin-bottom:0.85rem;}
.form-group label{display:block;font-size:0.78rem;font-weight:500;color:var(--text2);margin-bottom:0.3rem;}
.req{color:#ef4444;}
.form-group input,.form-group select,.form-group textarea{
  width:100%;padding:0.5rem 0.7rem;border:1.5px solid var(--border);
  border-radius:7px;font-family:'Noto Sans TC',sans-serif;font-size:0.86rem;
  color:var(--text);background:var(--surface);outline:none;transition:border-color .14s;
}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:#1a202c;}
.form-group textarea{resize:vertical;min-height:58px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;}
.form-msg{font-size:0.76rem;color:#ef4444;margin-top:0.4rem;display:none;line-height:1.5;}
.form-msg.ok{color:#059669;}
.btn-md{padding:0.5rem 1.1rem;border-radius:7px;font-family:'Noto Sans TC',sans-serif;font-size:0.83rem;font-weight:500;cursor:pointer;border:none;transition:all .14s;}
.btn-md.p{background:#1a202c;color:#fff;}.btn-md.p:hover{background:#2d3748;}
.btn-md.c{background:var(--bg);color:var(--text2);}.btn-md.c:hover{background:var(--border);}
.btn-md.d{background:#fee2e2;color:#dc2626;}.btn-md.d:hover{background:#fecaca;}
.btn-md:disabled{opacity:.5;cursor:not-allowed;}

/* Day detail modal */
.day-modal .modal{max-width:700px;}
.day-modal-hdr{padding:1.1rem 1.4rem 0.9rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.day-modal-hdr h3{font-family:'Noto Serif TC',serif;font-size:1.05rem;font-weight:700;}
.dept-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0.6rem;padding:1rem 1.2rem;min-height:220px;}
.dept-col{border:1.5px solid var(--border);border-radius:10px;overflow:hidden;display:flex;flex-direction:column;}
.dept-col-header{display:flex;align-items:center;gap:0.4rem;padding:0.55rem 0.7rem;font-size:0.82rem;font-weight:700;flex-shrink:0;}
.dept-col-body{padding:0.45rem 0.55rem;flex:1;overflow-y:auto;max-height:280px;}
.dept-ev-item{padding:0.4rem 0.5rem;border-radius:6px;margin-bottom:0.3rem;background:var(--surface2);border:1px solid var(--border);position:relative;}
.dept-ev-item.conflict-item{border-color:#f59e0b;background:#fffbeb;}
.dept-ev-title{font-size:0.82rem;font-weight:600;margin-bottom:0.18rem;}
.dept-ev-meta{font-size:0.7rem;color:var(--text2);display:flex;flex-wrap:wrap;gap:0.35rem;}
.dept-ev-actions{display:flex;gap:0.3rem;margin-top:0.35rem;}
.conflict-badge{font-size:0.65rem;background:#f59e0b;color:#fff;padding:0.1rem 0.35rem;border-radius:999px;display:inline-flex;align-items:center;gap:2px;margin-bottom:0.2rem;}
.btn-xs{padding:0.2rem 0.5rem;border-radius:4px;font-size:0.68rem;font-weight:500;cursor:pointer;border:none;font-family:'Noto Sans TC',sans-serif;transition:all .12s;}
.btn-xs.e{background:#f1f5f9;color:var(--text2);}.btn-xs.e:hover{background:var(--border);}
.btn-xs.d{background:#fee2e2;color:#dc2626;}.btn-xs.d:hover{background:#fecaca;}
.dept-empty{font-size:0.73rem;color:var(--text3);text-align:center;padding:0.75rem 0;}
.day-modal-footer{padding:0.85rem 1.4rem;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:flex-end;gap:0.45rem;}
.add-day-btn{padding:0.48rem 1rem;border-radius:7px;background:#1a202c;color:#fff;border:none;font-family:'Noto Sans TC',sans-serif;font-size:0.8rem;font-weight:500;cursor:pointer;display:none;transition:background .13s;}
.add-day-btn:hover{background:#2d3748;}

/* Batch modal */
.batch-tab{padding:0.25rem 0.7rem;border-radius:5px;font-size:0.76rem;font-weight:500;border:1px solid var(--border);background:none;color:var(--text2);cursor:pointer;font-family:'Noto Sans TC',sans-serif;transition:all .13s;}
.batch-tab:hover{background:var(--surface2);}
.batch-tab.active{background:#1a202c;border-color:#1a202c;color:#fff;}
.batch-input{width:100%;padding:0.26rem 0.42rem;border:1.5px solid transparent;border-radius:5px;font-family:'Noto Sans TC',sans-serif;font-size:0.78rem;color:var(--text);background:transparent;outline:none;transition:border-color .12s;}
.batch-input:focus{border-color:#1a202c;background:#fff;}
.batch-input.dirty{background:#fffbeb;border-color:#f59e0b;}
.batch-select{width:100%;padding:0.26rem 0.32rem;border:1.5px solid transparent;border-radius:5px;font-family:'Noto Sans TC',sans-serif;font-size:0.76rem;color:var(--text);background:transparent;outline:none;transition:border-color .12s;cursor:pointer;}
.batch-select:focus{border-color:#1a202c;background:#fff;}
.batch-select.dirty{background:#fffbeb;border-color:#f59e0b;}
.batch-row-new{background:#f0fdf4!important;}
.batch-tbody-row{border-bottom:1px solid var(--border);}
.batch-tbody-row:hover{background:#fafbfc;}
.batch-cell{padding:0.3rem 0.38rem;}

/* Login modal */
.login-modal .modal{max-width:360px;}

/* Loading */
.loading-overlay{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:300;flex-direction:column;gap:0.85rem;}
.spinner{width:30px;height:30px;border:3px solid var(--border);border-top-color:var(--text);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:0.82rem;color:var(--text3);}

@media(max-width:900px){.week-4col{grid-template-columns:1fr 1fr;}.dept-grid{grid-template-columns:1fr 1fr;}}

/* â”€â”€ Mobile styles (â‰¤640px) â”€â”€ */
/* mob-drawer and overlay: always hidden unless on mobile AND open */
.mob-drawer-overlay{display:none;}
.mob-drawer{display:none;}

/* mob-filter-row hidden on desktop, shown on mobile via media query */
.mob-filter-row{display:none;}

@media(max-width:640px){
  /* Sidebar hidden on mobile â€” replaced by bottom drawer */
  .sidebar{display:none;}
  .school-title{display:none;}
  .header-date{display:none;}
  .header-ticker{display:none;}

  /* Header compact */
  header{padding:0 0.75rem;height:52px;}
  .header-right{gap:0.4rem;}
  #btn-batch{display:none!important;}
  #btn-add-header{font-size:0.75rem;padding:0.3rem 0.7rem;}

  /* Location bar: collapsed by default, toggle button */
  .location-bar{padding:0;height:0;overflow:hidden;border:none;transition:height .25s;}
  .location-bar.mob-open{height:auto;padding:0.5rem 0.75rem;border-bottom:1px solid var(--border);overflow:visible;}

  /* Mobile filter bar replaces location bar header area */
  .mob-filter-row{
    display:flex!important;background:var(--surface);border-bottom:1px solid var(--border);
    padding:0.4rem 0.75rem;gap:0.5rem;align-items:center;
    position:sticky;top:52px;z-index:98;flex-shrink:0;
  }
  .mob-pill-btn{
    display:inline-flex;align-items:center;gap:0.3rem;
    padding:0.3rem 0.75rem;border-radius:999px;border:1.5px solid var(--border);
    background:var(--surface);font-family:'Noto Sans TC',sans-serif;
    font-size:0.78rem;font-weight:500;cursor:pointer;color:var(--text2);transition:all .14s;
    white-space:nowrap;
  }
  .mob-pill-btn.has-filter{background:#1a202c;border-color:#1a202c;color:#fff;}

  /* Drawer overlay */
  .mob-drawer-overlay{
    display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;
    backdrop-filter:blur(2px);
  }
  .mob-drawer-overlay.open{display:block;}
  .mob-drawer{
    display:flex;flex-direction:column;
    position:fixed;bottom:0;left:0;right:0;
    background:var(--surface);border-radius:18px 18px 0 0;
    box-shadow:0 -4px 24px rgba(0,0,0,.14);
    padding:0 0 env(safe-area-inset-bottom,0);
    z-index:501;
    transform:translateY(100%);transition:transform .28s cubic-bezier(.16,1,.3,1);
    max-height:80vh;
  }
  .mob-drawer.open{transform:translateY(0);}
  .mob-drawer-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:10px auto 0;}
  .mob-drawer-title{font-size:0.9rem;font-weight:700;padding:0.75rem 1.1rem 0.5rem;border-bottom:1px solid var(--border);}
  .mob-drawer-body{padding:0.75rem 1rem 1.25rem;overflow-y:auto;display:flex;flex-direction:column;gap:0.45rem;}

  /* Dept buttons in drawer */
  .mob-dept-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;}
  .mob-dept-item{
    padding:0.7rem 0.75rem;border-radius:10px;border:1.5px solid var(--border);
    background:none;font-family:'Noto Sans TC',sans-serif;font-size:0.85rem;font-weight:500;
    cursor:pointer;display:flex;align-items:center;gap:0.5rem;color:var(--text2);transition:all .14s;
  }
  .mob-dept-item:hover{background:var(--surface2);}
  .mob-dept-item.active{color:#fff;border-color:transparent;}
  .mob-dept-item.active-all{background:#1a202c;}
  .mob-dept-item.active-æ•™å‹™è™•{background:var(--æ•™å‹™è™•);}
  .mob-dept-item.active-å­¸å‹™è™•{background:var(--å­¸å‹™è™•);}
  .mob-dept-item.active-è¼”å°è™•{background:var(--è¼”å°è™•);}
  .mob-dept-item.active-ç¸½å‹™è™•{background:var(--ç¸½å‹™è™•);}
  .mob-dept-item.active .d-dot{background:rgba(255,255,255,.6)!important;}

  /* Location buttons in drawer: wrap */
  .mob-loc-grid{display:flex;flex-wrap:wrap;gap:0.4rem;}
  .mob-loc-item{
    padding:0.35rem 0.75rem;border-radius:999px;border:1.5px solid var(--border);
    background:var(--surface);font-family:'Noto Sans TC',sans-serif;font-size:0.8rem;font-weight:500;
    cursor:pointer;color:var(--text2);transition:all .14s;display:inline-flex;align-items:center;gap:4px;
  }
  .mob-loc-item.active{background:#1a202c;border-color:#1a202c;color:#fff;}

  /* Floating action buttons (bottom right) */
  .mob-fab-area{
    position:fixed;bottom:1.25rem;right:1rem;
    display:flex;flex-direction:column;gap:0.5rem;align-items:flex-end;z-index:100;
  }
  .mob-fab{
    width:48px;height:48px;border-radius:50%;border:none;
    font-size:1.1rem;cursor:pointer;box-shadow:0 3px 12px rgba(0,0,0,.18);
    display:flex;align-items:center;justify-content:center;transition:all .15s;
  }
  .mob-fab:active{transform:scale(.93);}
  .mob-fab-add{background:#1a202c;color:#fff;}
  .mob-fab-filter{background:var(--surface);color:var(--text);border:1px solid var(--border)!important;}
  .mob-fab-label{font-size:0.62rem;font-weight:600;margin-top:2px;color:var(--text3);text-align:center;}

  /* Calendar adjustments â€” fixed size, uniform cells */
  .cal-wrap{padding:0.5rem 0.35rem;}
  .cal-day{
    height:62px !important;
    min-height:unset !important;
    max-height:62px !important;
    padding:0.18rem 0.15rem;
    overflow:hidden;
  }
  .day-num-wrap{margin-bottom:0.1rem;}
  .day-num{width:20px;height:20px;font-size:0.7rem;}
  .holiday-name{display:none;}
  /* Each chip: single line, fixed height, 2-char title */
  .event-chip{
    font-size:0.65rem;
    padding:1px 3px;
    display:block !important;
    line-height:1.4;
    height:16px;
    overflow:hidden;
  }
  .chip-time{display:none;}
  .chip-loc{display:none;}
  .chip-title{
    overflow:hidden;
    white-space:nowrap;
    text-overflow:clip;
    display:block;
    max-width:100%;
  }
  /* Max 2 chips visible per day */
  .day-events{gap:1px;overflow:hidden;max-height:34px;}
  .more-chip{font-size:0.55rem;line-height:1.3;}

  /* Quick nav mobile: horizontal scroll */
  .quick-nav{flex-wrap:nowrap;overflow-x:auto;padding:0.45rem 0.75rem;gap:0.3rem;-webkit-overflow-scrolling:touch;}
  .quick-nav::-webkit-scrollbar{display:none;}
  .qnav-label{font-size:0.72rem;}
  .qnav-btn{padding:0.2rem 0.45rem;font-size:0.72rem;}
  .year-select{font-size:0.72rem;padding:0.2rem 0.38rem;}

  /* Cal nav */
  .cal-nav{padding:0 0.25rem;}
  .cal-month{font-size:1rem;min-width:110px;}

  /* Week view on mobile: single col */
  .week-4col{grid-template-columns:1fr;}

  /* Day modal: full dept grid 1 col */
  .dept-grid{grid-template-columns:1fr 1fr;gap:0.5rem;padding:0.75rem;}
}
@media(max-width:400px){
  .dept-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<div class="loading-overlay" id="loading"><div class="spinner"></div><div class="loading-text">è¼‰å…¥ä¸­â€¦</div></div>

<!-- Header -->
<header>
  <div class="header-left">
    <div class="school-badge">æ–°èŠåœ‹å°</div>
    <span class="school-title">å­¸æ ¡è¡Œäº‹æ›†</span>
    <span class="header-date" id="header-date"></span>
  </div>
  <div class="header-ticker" id="header-ticker">
    <div class="ticker-empty">è¼‰å…¥ä»Šæ—¥æ´»å‹•ä¸­â€¦</div>
  </div>
  <div class="header-right">
    <div id="user-info">
      <span id="user-email-show" style="font-size:0.72rem;color:var(--text3)"></span>
    </div>
    <button id="btn-batch" onclick="openBatchModal()">ğŸ“‹ æ‰¹æ¬¡ç®¡ç†</button>
    <button id="btn-add-header" onclick="openAddModal(null)">ï¼‹ æ–°å¢æ´»å‹•</button>
    <button id="btn-admin" onclick="openAdminModal()" style="display:none;padding:0.35rem 0.85rem;border-radius:6px;font-family:'Noto Sans TC',sans-serif;font-size:0.78rem;font-weight:500;cursor:pointer;border:1px solid #f59e0b;background:#fffbeb;color:#92400e;transition:all .14s;">âš™ æ¬Šé™ç®¡ç†</button>
    <button class="btn-sm btn-ghost" id="btn-logout" style="display:none" onclick="handleLogout()">ç™»å‡º</button>
    <button class="btn-sm btn-primary" id="btn-login-open" onclick="openLoginModal()">æ•™è·å“¡ç™»å…¥</button>
  </div>
</header>

<!-- Location Filter Bar (desktop) - now hidden, filters moved to sidebar -->
<div class="location-bar" id="location-bar" style="display:none;">
  <span class="loc-label">åœ°é»ï¼š</span>
</div>

<!-- Mobile filter row (visible on mobile only) -->
<div class="mob-filter-row" style="display:none;" id="mob-filter-row">
  <button class="mob-pill-btn" id="mob-dept-btn" onclick="openMobDrawer('dept')">
    <span class="d-dot" id="mob-dept-dot" style="background:#94a3b8;border-radius:2px;"></span>
    <span id="mob-dept-label">è™•å®¤</span> â–¾
  </button>
  <button class="mob-pill-btn" id="mob-loc-btn" onclick="openMobDrawer('loc')">
    ğŸ“ <span id="mob-loc-label">åœ°é»</span> â–¾
  </button>
  <div style="flex:1"></div>
  <button class="mob-pill-btn" id="mob-batch-btn" style="display:none;" onclick="openBatchModal()">ğŸ“‹</button>
</div>

<!-- Mobile Drawer Overlay -->
<div class="mob-drawer-overlay" id="mob-overlay" onclick="closeMobDrawer()"></div>

<!-- Dept drawer -->
<div class="mob-drawer" id="mob-drawer-dept">
  <div class="mob-drawer-handle"></div>
  <div class="mob-drawer-title">ç¯©é¸è™•å®¤</div>
  <div class="mob-drawer-body">
    <div class="mob-dept-grid">
      <button class="mob-dept-item active active-all" id="mdbtn-all" onclick="mobSetDept('all')"><span class="d-dot" style="background:#94a3b8"></span>å…¨éƒ¨</button>
      <button class="mob-dept-item" id="mdbtn-æ•™å‹™è™•" onclick="mobSetDept('æ•™å‹™è™•')"><span class="d-dot dot-æ•™å‹™è™•"></span>æ•™å‹™è™•</button>
      <button class="mob-dept-item" id="mdbtn-å­¸å‹™è™•" onclick="mobSetDept('å­¸å‹™è™•')"><span class="d-dot dot-å­¸å‹™è™•"></span>å­¸å‹™è™•</button>
      <button class="mob-dept-item" id="mdbtn-è¼”å°è™•" onclick="mobSetDept('è¼”å°è™•')"><span class="d-dot dot-è¼”å°è™•"></span>è¼”å°è™•</button>
      <button class="mob-dept-item" id="mdbtn-ç¸½å‹™è™•" onclick="mobSetDept('ç¸½å‹™è™•')"><span class="d-dot dot-ç¸½å‹™è™•"></span>ç¸½å‹™è™•</button>
    </div>
  </div>
</div>

<!-- Location drawer -->
<div class="mob-drawer" id="mob-drawer-loc">
  <div class="mob-drawer-handle"></div>
  <div class="mob-drawer-title">ç¯©é¸åœ°é»</div>
  <div class="mob-drawer-body">
    <div class="mob-loc-grid" id="mob-loc-grid"></div>
  </div>
</div>

<!-- Body -->
<div class="body-wrap">
  <div class="sidebar" id="desktop-sidebar">
    <div class="sidebar-label">è™•å®¤ç¯©é¸</div>
    <button class="dept-btn active active-all" id="dbtn-all" onclick="setDeptFilter('all')"><span class="d-dot" style="background:#94a3b8"></span>å…¨éƒ¨</button>
    <button class="dept-btn" id="dbtn-æ•™å‹™è™•" onclick="setDeptFilter('æ•™å‹™è™•')"><span class="d-dot dot-æ•™å‹™è™•"></span>æ•™å‹™è™•</button>
    <button class="dept-btn" id="dbtn-å­¸å‹™è™•" onclick="setDeptFilter('å­¸å‹™è™•')"><span class="d-dot dot-å­¸å‹™è™•"></span>å­¸å‹™è™•</button>
    <button class="dept-btn" id="dbtn-è¼”å°è™•" onclick="setDeptFilter('è¼”å°è™•')"><span class="d-dot dot-è¼”å°è™•"></span>è¼”å°è™•</button>
    <button class="dept-btn" id="dbtn-ç¸½å‹™è™•" onclick="setDeptFilter('ç¸½å‹™è™•')"><span class="d-dot dot-ç¸½å‹™è™•"></span>ç¸½å‹™è™•</button>
    <div class="sidebar-divider"></div>
    <button class="add-btn-side" id="add-btn-side" onclick="openAddModal(null)" style="display:none;width:100%;padding:0.5rem 0.6rem;border-radius:8px;background:#1a202c;color:#fff;border:none;font-family:'Noto Sans TC',sans-serif;font-size:0.8rem;font-weight:500;cursor:pointer;transition:background .14s;">ï¼‹ æ–°å¢</button>
  </div>

  <div class="cal-wrap">
    <!-- Quick month/year nav -->
    <div class="quick-nav" id="quick-nav">
      <span class="qnav-label">å¹´ä»½ï¼š</span>
      <select class="year-select" id="year-select" onchange="setYear(this.value)"></select>
      <div class="qnav-sep"></div>
      <span class="qnav-label">æœˆä»½ï¼š</span>
      <span id="month-btns"></span>
    </div>

    <!-- Location filter bar (desktop) -->
    <div id="loc-bar" style="display:flex;align-items:center;gap:0.35rem;flex-wrap:wrap;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:0.45rem 0.85rem;">
      <span class="qnav-label">åœ°é»ï¼š</span>
      <button class="loc-bar-btn active" id="locbtn-all" onclick="setLocFilter('all')">å…¨éƒ¨</button>
    </div>

    <!-- Cal nav -->
    <div class="cal-nav">
      <div class="cal-nav-center">
        <button class="icon-btn" id="nav-prev" onclick="navPrev()">â€¹</button>
        <div class="cal-month" id="cal-month-label"></div>
        <button class="icon-btn" id="nav-next" onclick="navNext()">â€º</button>
      </div>
      <div style="display:flex;align-items:center;gap:0.45rem;">
        <div class="view-toggle">
          <button id="view-btn-month" class="active" onclick="setView('month')">æœˆæ›†</button>
          <button id="view-btn-week" onclick="setView('week')">é€±åˆ—è¡¨</button>
        </div>
        <button class="today-btn" onclick="goToday()">ä»Šå¤©</button>
      </div>
    </div>

    <!-- Month view -->
    <div id="view-month">
      <div class="cal-grid">
        <div class="cal-weekdays">
          <div class="cal-weekday">æ—¥</div><div class="cal-weekday">ä¸€</div>
          <div class="cal-weekday">äºŒ</div><div class="cal-weekday">ä¸‰</div>
          <div class="cal-weekday">å››</div><div class="cal-weekday">äº”</div>
          <div class="cal-weekday">å…­</div>
        </div>
        <div class="cal-days" id="cal-days"></div>
      </div>
    </div>

    <!-- Week view -->
    <div id="view-week" style="display:none;">
      <div class="week-4col" id="week-4col"></div>
    </div>
  </div>
</div>

<!-- Day detail modal -->
<div class="modal-overlay day-modal" id="modal-day">
  <div class="modal" style="max-width:780px;">
    <div class="day-modal-hdr">
      <h3 id="day-hdr-title"></h3>
      <button class="modal-close" onclick="closeDayModal()">âœ•</button>
    </div>
    <div class="dept-grid" id="dept-grid"></div>
    <div class="day-modal-footer">
      <button id="comp-day-btn" onclick="toggleCompDayFromModal()" style="display:none;padding:0.48rem 0.9rem;border-radius:7px;border:1.5px solid #fca5a5;background:#fff5f5;color:#dc2626;font-family:'Noto Sans TC',sans-serif;font-size:0.8rem;font-weight:500;cursor:pointer;transition:all .14s;" title="é•·æŒ‰æ—¥æœŸæ ¼ä¹Ÿå¯åˆ‡æ›">ğŸ—“ è¨­ç‚ºè£œä¼‘æ—¥</button>
      <button class="add-day-btn" id="add-day-btn" onclick="addFromDay()">ï¼‹ æ–°å¢é€™å¤©çš„æ´»å‹•</button>
      <button class="btn-md c" onclick="closeDayModal()">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- Add/Edit modal -->
<div class="modal-overlay" id="modal-add">
  <div class="modal">
    <div class="modal-header"><h3 id="add-modal-title">æ–°å¢æ´»å‹•</h3><button class="modal-close" onclick="closeAddModal()">âœ•</button></div>
    <div class="modal-body">
      <div class="form-group"><label>æ´»å‹•åç¨± <span class="req">*</span></label><input type="text" id="ev-title" placeholder="ä¾‹ï¼šæœŸä¸­è€ƒã€ç­è¦ªæœƒâ€¦"></div>
      <div class="form-row">
        <div class="form-group"><label>é–‹å§‹æ—¥æœŸ <span class="req">*</span></label><input type="date" id="ev-start"></div>
        <div class="form-group"><label>çµæŸæ—¥æœŸ <span class="req">*</span></label><input type="date" id="ev-end"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>é–‹å§‹æ™‚é–“</label><input type="time" id="ev-stime"></div>
        <div class="form-group"><label>çµæŸæ™‚é–“</label><input type="time" id="ev-etime"></div>
      </div>
      <div class="form-group">
        <label>åœ°é» / æ•™å®¤ <span class="req">*</span></label>
        <select id="ev-location">
          <option value="">è«‹é¸æ“‡åœ°é»</option>
          <option>1Få¤§ç©¿å ‚</option><option>1Få°ç„é—œ</option><option>1Féœæ€æ›¸è»’</option>
          <option>2Fæ ¡é•·å®¤æ—æœƒè­°å®¤</option><option>3Fè¦–è½æ•™å®¤</option><option>4Fåœ–æ›¸é¤¨</option>
          <option>4Fæ¨‚æ´»æ•™å®¤</option><option>5Fæ´»å‹•ä¸­å¿ƒ</option>
          <option>çƒå ´å—ä¸€ï¼ˆäºŒ.äº”.å…­å¹´ç´šï¼‰</option><option>çƒå ´å—äºŒï¼ˆäºŒ.äº”.å…­å¹´ç´šï¼‰</option>
          <option>çƒå ´åŒ—ä¸€ï¼ˆä¸€.ä¸‰.å››å¹´ç´šï¼‰</option><option>çƒå ´åŒ—äºŒï¼ˆä¸€.ä¸‰.å››å¹´ç´šï¼‰</option>
          <option>æ¡Œçƒæ•™å®¤</option><option>æŒ‡å®šç­ç´šæ•™å®¤</option><option>æ ¡å¤–</option>
        </select>
      </div>
      <div class="form-group">
        <label>æ‰€å±¬è™•å®¤ <span class="req">*</span></label>
        <select id="ev-dept"><option value="æ•™å‹™è™•">æ•™å‹™è™•</option><option value="å­¸å‹™è™•">å­¸å‹™è™•</option><option value="è¼”å°è™•">è¼”å°è™•</option><option value="ç¸½å‹™è™•">ç¸½å‹™è™•</option></select>
      </div>
      <div class="form-group"><label>å‚™è¨»èªªæ˜</label><textarea id="ev-note" placeholder="é¸å¡«ï¼Œå¯å¡«åœ°é»ä»£ç¢¼ã€è¯çµ¡äººã€æ³¨æ„äº‹é …â€¦"></textarea></div>
      <div class="form-msg" id="add-msg"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-md d" id="btn-del-ev" style="display:none" onclick="handleDeleteEvent()">åˆªé™¤</button>
      <div style="flex:1"></div>
      <button class="btn-md c" onclick="closeAddModal()">å–æ¶ˆ</button>
      <button class="btn-md p" id="btn-save-ev" onclick="handleSaveEvent()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- Batch modal -->
<div class="modal-overlay" id="modal-batch" style="align-items:flex-start;padding:0;">
  <div class="modal" style="max-width:100%;width:100%;height:100vh;border-radius:0;display:flex;flex-direction:column;max-height:100vh;">
    <div class="modal-header" style="flex-shrink:0;">
      <div style="display:flex;align-items:center;gap:0.65rem;flex-wrap:wrap;">
        <h3>ğŸ“‹ æ‰¹æ¬¡ç®¡ç†</h3>
        <div style="display:flex;gap:0.3rem;">
          <button class="batch-tab active" id="btab-table" onclick="switchBatchTab('table')">ğŸ“Š è¡¨æ ¼ç·¨è¼¯</button>
          <button class="batch-tab" id="btab-paste" onclick="switchBatchTab('paste')">ğŸ“ è²¼ä¸Šæ–‡å­—</button>
          <button class="batch-tab" id="btab-csv" onclick="switchBatchTab('csv')">ğŸ“ åŒ¯å…¥CSV</button>
        </div>
      </div>
      <button class="modal-close" onclick="closeBatchModal()">âœ•</button>
    </div>
    <!-- Table tab -->
    <div id="batch-panel-table" style="flex:1;display:flex;flex-direction:column;min-height:0;">
      <div style="padding:0.6rem 1.2rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:0.65rem;flex-wrap:wrap;flex-shrink:0;">
        <span style="font-size:0.8rem;color:var(--text2);">è™•å®¤ï¼š</span>
        <select id="table-filter-dept" onchange="renderBatchTable()" style="padding:0.28rem 0.55rem;border:1.5px solid var(--border);border-radius:6px;font-family:'Noto Sans TC',sans-serif;font-size:0.8rem;outline:none;">
          <option value="all">å…¨éƒ¨</option><option value="æ•™å‹™è™•">æ•™å‹™è™•</option><option value="å­¸å‹™è™•">å­¸å‹™è™•</option><option value="è¼”å°è™•">è¼”å°è™•</option><option value="ç¸½å‹™è™•">ç¸½å‹™è™•</option>
        </select>
        <button onclick="addBatchRow()" style="padding:0.28rem 0.8rem;border-radius:6px;background:#1a202c;color:#fff;border:none;font-family:'Noto Sans TC',sans-serif;font-size:0.8rem;cursor:pointer;">ï¼‹ æ–°å¢åˆ—</button>
        <button onclick="saveBatchTable()" id="btn-save-batch-table" style="padding:0.28rem 0.8rem;border-radius:6px;background:#059669;color:#fff;border:none;font-family:'Noto Sans TC',sans-serif;font-size:0.8rem;cursor:pointer;">ğŸ’¾ å…¨éƒ¨å„²å­˜</button>
        <span id="batch-table-msg" style="font-size:0.76rem;color:#059669;display:none;"></span>
        <button onclick="downloadCSVTemplate()" style="padding:0.28rem 0.8rem;border-radius:6px;background:var(--surface2);color:var(--text2);border:1px solid var(--border);font-family:'Noto Sans TC',sans-serif;font-size:0.76rem;cursor:pointer;margin-left:auto;">â¬‡ ä¸‹è¼‰CSVç¯„æœ¬</button>
      </div>
      <div style="flex:1;overflow:auto;">
        <table id="batch-table" style="width:100%;border-collapse:collapse;font-size:0.8rem;">
          <thead><tr style="background:var(--surface2);position:sticky;top:0;z-index:1;">
            <th style="padding:0.5rem 0.65rem;text-align:left;border-bottom:2px solid var(--border);font-weight:600;color:var(--text2);width:32px;">#</th>
            <th style="padding:0.5rem 0.65rem;text-align:left;border-bottom:2px solid var(--border);font-weight:600;color:var(--text2);">æ´»å‹•åç¨± *</th>
            <th style="padding:0.5rem 0.65rem;text-align:left;border-bottom:2px solid var(--border);font-weight:600;color:var(--text2);white-space:nowrap;">é–‹å§‹æ—¥æœŸ *</th>
            <th style="padding:0.5rem 0.65rem;text-align:left;border-bottom:2px solid var(--border);font-weight:600;color:var(--text2);white-space:nowrap;">çµæŸæ—¥æœŸ</th>
            <th style="padding:0.5rem 0.65rem;text-align:left;border-bottom:2px solid var(--border);font-weight:600;color:var(--text2);white-space:nowrap;">é–‹å§‹æ™‚é–“</th>
            <th style="padding:0.5rem 0.65rem;text-align:left;border-bottom:2px solid var(--border);font-weight:600;color:var(--text2);white-space:nowrap;">çµæŸæ™‚é–“</th>
            <th style="padding:0.5rem 0.65rem;text-align:left;border-bottom:2px solid var(--border);font-weight:600;color:var(--text2);">åœ°é» *</th>
            <th style="padding:0.5rem 0.65rem;text-align:left;border-bottom:2px solid var(--border);font-weight:600;color:var(--text2);">è™•å®¤ *</th>
            <th style="padding:0.5rem 0.65rem;text-align:left;border-bottom:2px solid var(--border);font-weight:600;color:var(--text2);">å‚™è¨»</th>
            <th style="padding:0.5rem 0.65rem;text-align:center;border-bottom:2px solid var(--border);font-weight:600;color:var(--text2);width:55px;">æ“ä½œ</th>
          </tr></thead>
          <tbody id="batch-tbody"></tbody>
        </table>
      </div>
    </div>
    <!-- Paste tab -->
    <div id="batch-panel-paste" style="display:none;flex:1;flex-direction:column;min-height:0;padding:1.1rem 1.25rem;overflow-y:auto;">
      <p style="font-size:0.83rem;color:var(--text2);margin-bottom:0.9rem;line-height:1.7;">æ”¯æ´æ ¼å¼ï¼š<code style="background:var(--surface2);padding:0.1rem 0.35rem;border-radius:4px;font-size:0.78rem;">3/12æ´»å‹•åç¨±</code> <code style="background:var(--surface2);padding:0.1rem 0.35rem;border-radius:4px;font-size:0.78rem;">3/26~3/28è·¨å¤©æ´»å‹•</code></p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.85rem;margin-bottom:0.85rem;">
        <div><label style="font-size:0.78rem;font-weight:500;color:var(--text2);display:block;margin-bottom:0.3rem;">é è¨­è™•å®¤</label>
        <select id="paste-dept" style="width:100%;padding:0.48rem 0.65rem;border:1.5px solid var(--border);border-radius:7px;font-family:'Noto Sans TC',sans-serif;font-size:0.86rem;outline:none;"><option value="æ•™å‹™è™•">æ•™å‹™è™•</option><option value="å­¸å‹™è™•">å­¸å‹™è™•</option><option value="è¼”å°è™•">è¼”å°è™•</option><option value="ç¸½å‹™è™•">ç¸½å‹™è™•</option></select></div>
        <div><label style="font-size:0.78rem;font-weight:500;color:var(--text2);display:block;margin-bottom:0.3rem;">é è¨­åœ°é»</label>
        <select id="paste-loc" style="width:100%;padding:0.48rem 0.65rem;border:1.5px solid var(--border);border-radius:7px;font-family:'Noto Sans TC',sans-serif;font-size:0.86rem;outline:none;"><option value="">ï¼ˆä¹‹å¾Œå†å¡«ï¼‰</option><option>1Få¤§ç©¿å ‚</option><option>1Få°ç„é—œ</option><option>1Féœæ€æ›¸è»’</option><option>2Fæ ¡é•·å®¤æ—æœƒè­°å®¤</option><option>3Fè¦–è½æ•™å®¤</option><option>4Fåœ–æ›¸é¤¨</option><option>4Fæ¨‚æ´»æ•™å®¤</option><option>5Fæ´»å‹•ä¸­å¿ƒ</option><option>çƒå ´å—ä¸€ï¼ˆäºŒ.äº”.å…­å¹´ç´šï¼‰</option><option>çƒå ´å—äºŒï¼ˆäºŒ.äº”.å…­å¹´ç´šï¼‰</option><option>çƒå ´åŒ—ä¸€ï¼ˆä¸€.ä¸‰.å››å¹´ç´šï¼‰</option><option>çƒå ´åŒ—äºŒï¼ˆä¸€.ä¸‰.å››å¹´ç´šï¼‰</option><option>æ¡Œçƒæ•™å®¤</option><option>æŒ‡å®šç­ç´šæ•™å®¤</option><option>æ ¡å¤–</option></select></div>
      </div>
      <label style="font-size:0.78rem;font-weight:500;color:var(--text2);display:block;margin-bottom:0.3rem;">è²¼ä¸Šæ–‡å­—ï¼ˆæ¯è¡Œä¸€ç­†ï¼‰</label>
      <textarea id="paste-text" rows="10" placeholder="3/12äº”å¹´ç´šè‹±èªæ­Œå”±æ¯”è³½&#10;3/26~3/28æ–°ç”Ÿå ±åˆ°&#10;6/12ç•¢æ¥­å…¸ç¦®" style="width:100%;padding:0.55rem 0.7rem;border:1.5px solid var(--border);border-radius:8px;font-family:'Noto Sans TC',sans-serif;font-size:0.86rem;color:var(--text);outline:none;resize:vertical;line-height:1.7;"></textarea>
      <div style="margin-top:0.65rem;display:flex;gap:0.45rem;align-items:center;">
        <button onclick="parsePasteText()" style="padding:0.48rem 1.1rem;border-radius:7px;background:#1a202c;color:#fff;border:none;font-family:'Noto Sans TC',sans-serif;font-size:0.83rem;font-weight:500;cursor:pointer;">è§£æé è¦½</button>
        <span id="paste-msg" style="font-size:0.76rem;color:var(--text2);display:none;"></span>
      </div>
      <div id="paste-preview" style="display:none;margin-top:0.85rem;">
        <div style="font-size:0.8rem;font-weight:600;color:var(--text2);margin-bottom:0.4rem;">é è¦½çµæœï¼ˆå¯ä¿®æ”¹å¾Œå†åŒ¯å…¥ï¼‰ï¼š</div>
        <div style="overflow-x:auto;border:1px solid var(--border);border-radius:8px;">
          <table id="paste-preview-table" style="width:100%;border-collapse:collapse;font-size:0.8rem;">
            <thead><tr style="background:var(--surface2);">
              <th style="padding:0.4rem 0.6rem;text-align:left;border-bottom:1px solid var(--border);font-weight:600;color:var(--text2);">æ´»å‹•åç¨±</th>
              <th style="padding:0.4rem 0.6rem;text-align:left;border-bottom:1px solid var(--border);font-weight:600;color:var(--text2);">é–‹å§‹æ—¥æœŸ</th>
              <th style="padding:0.4rem 0.6rem;text-align:left;border-bottom:1px solid var(--border);font-weight:600;color:var(--text2);">çµæŸæ—¥æœŸ</th>
              <th style="padding:0.4rem 0.6rem;text-align:left;border-bottom:1px solid var(--border);font-weight:600;color:var(--text2);">è™•å®¤</th>
              <th style="padding:0.4rem 0.6rem;text-align:left;border-bottom:1px solid var(--border);font-weight:600;color:var(--text2);">åœ°é»</th>
              <th style="padding:0.4rem 0.6rem;text-align:center;border-bottom:1px solid var(--border);width:36px;"></th>
            </tr></thead>
            <tbody id="paste-preview-tbody"></tbody>
          </table>
        </div>
        <div style="margin-top:0.75rem;display:flex;gap:0.45rem;align-items:center;">
          <button onclick="importParsed()" id="btn-import-parsed" style="padding:0.48rem 1.1rem;border-radius:7px;background:#059669;color:#fff;border:none;font-family:'Noto Sans TC',sans-serif;font-size:0.83rem;font-weight:500;cursor:pointer;">âœ… ç¢ºèªåŒ¯å…¥</button>
          <span id="import-msg" style="font-size:0.76rem;color:var(--text2);display:none;"></span>
        </div>
      </div>
    </div>
    <!-- CSV tab -->
    <div id="batch-panel-csv" style="display:none;flex:1;flex-direction:column;padding:1.1rem 1.25rem;overflow-y:auto;">
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:1rem 1.1rem;margin-bottom:1.1rem;">
        <div style="font-size:0.86rem;font-weight:600;margin-bottom:0.45rem;">ğŸ“‹ CSV æ ¼å¼èªªæ˜</div>
        <div style="font-size:0.78rem;color:var(--text2);line-height:1.8;">æ¬„ä½ï¼š<code style="background:var(--surface);padding:0.1rem 0.32rem;border-radius:4px;font-size:0.76rem;">æ´»å‹•åç¨±,é–‹å§‹æ—¥æœŸ,çµæŸæ—¥æœŸ,é–‹å§‹æ™‚é–“,çµæŸæ™‚é–“,åœ°é»,è™•å®¤,å‚™è¨»</code><br>æ—¥æœŸï¼š<code style="background:var(--surface);padding:0.1rem 0.32rem;border-radius:4px;font-size:0.76rem;">2026-03-12</code>ã€€æ™‚é–“ï¼š<code style="background:var(--surface);padding:0.1rem 0.32rem;border-radius:4px;font-size:0.76rem;">09:00</code>ï¼ˆé¸å¡«ï¼‰</div>
        <button onclick="downloadCSVTemplate()" style="margin-top:0.65rem;padding:0.35rem 0.9rem;border-radius:6px;background:var(--surface);border:1.5px solid var(--border);font-family:'Noto Sans TC',sans-serif;font-size:0.78rem;cursor:pointer;color:var(--text2);">â¬‡ ä¸‹è¼‰ CSV ç¯„æœ¬</button>
      </div>
      <div style="border:2px dashed var(--border);border-radius:10px;padding:1.75rem;text-align:center;cursor:pointer;transition:all .15s;" id="csv-drop-zone" onclick="document.getElementById('csv-file-input').click()" ondragover="event.preventDefault();this.style.borderColor='#1a202c'" ondragleave="this.style.borderColor='var(--border)'" ondrop="handleCSVDrop(event)">
        <div style="font-size:1.6rem;margin-bottom:0.4rem;">ğŸ“</div>
        <div style="font-size:0.86rem;font-weight:500;color:var(--text2);">é»æ“Šé¸æ“‡ CSV æª”æ¡ˆï¼Œæˆ–æ‹–æ›³åˆ°é€™è£¡</div>
        <input type="file" id="csv-file-input" accept=".csv" style="display:none" onchange="handleCSVFile(this)">
      </div>
      <div id="csv-preview" style="display:none;margin-top:1.1rem;">
        <div style="font-size:0.8rem;font-weight:600;color:var(--text2);margin-bottom:0.4rem;" id="csv-preview-label"></div>
        <div style="overflow-x:auto;border:1px solid var(--border);border-radius:8px;">
          <table id="csv-preview-table" style="width:100%;border-collapse:collapse;font-size:0.78rem;">
            <thead id="csv-preview-thead" style="background:var(--surface2);"></thead>
            <tbody id="csv-preview-tbody"></tbody>
          </table>
        </div>
        <div style="margin-top:0.75rem;display:flex;gap:0.45rem;align-items:center;">
          <button onclick="importCSV()" id="btn-import-csv" style="padding:0.48rem 1.1rem;border-radius:7px;background:#059669;color:#fff;border:none;font-family:'Noto Sans TC',sans-serif;font-size:0.83rem;font-weight:500;cursor:pointer;">âœ… ç¢ºèªåŒ¯å…¥</button>
          <span id="csv-import-msg" style="font-size:0.76rem;color:var(--text2);display:none;"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Admin Modal -->
<div class="modal-overlay" id="modal-admin">
  <div class="modal" style="max-width:560px;">
    <div class="modal-header">
      <h3>âš™ æ¬Šé™ç®¡ç†</h3>
      <button class="modal-close" onclick="closeAdminModal()">âœ•</button>
    </div>
    <div class="modal-body" style="padding:0;">
      <!-- Pending approvals -->
      <div style="padding:1rem 1.4rem 0.5rem;">
        <div style="font-size:0.82rem;font-weight:700;color:var(--text2);margin-bottom:0.6rem;">ğŸ“‹ å¾…å¯©æ ¸å¸³è™Ÿ</div>
        <div id="admin-pending" style="display:flex;flex-direction:column;gap:0.4rem;min-height:32px;">
          <div style="font-size:0.78rem;color:var(--text3);">è¼‰å…¥ä¸­â€¦</div>
        </div>
      </div>
      <div style="height:1px;background:var(--border);margin:0.75rem 0;"></div>
      <!-- Approved editors -->
      <div style="padding:0 1.4rem 0.5rem;">
        <div style="font-size:0.82rem;font-weight:700;color:var(--text2);margin-bottom:0.6rem;">âœ… å·²æ ¸å‡†ç·¨è¼¯å¸³è™Ÿ</div>
        <div id="admin-editors" style="display:flex;flex-direction:column;gap:0.4rem;min-height:32px;">
          <div style="font-size:0.78rem;color:var(--text3);">è¼‰å…¥ä¸­â€¦</div>
        </div>
      </div>
      <div style="height:1px;background:var(--border);margin:0.75rem 0;"></div>
      <!-- Manual add -->
      <div style="padding:0 1.4rem 1rem;">
        <div style="font-size:0.82rem;font-weight:700;color:var(--text2);margin-bottom:0.6rem;">â• æ‰‹å‹•æ–°å¢ç·¨è¼¯æ¬Šé™</div>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <input type="email" id="admin-add-email" placeholder="è¼¸å…¥ email åœ°å€" style="flex:1;padding:0.45rem 0.65rem;border:1.5px solid var(--border);border-radius:7px;font-family:'Noto Sans TC',sans-serif;font-size:0.84rem;outline:none;">
          <button onclick="adminGrantEditor(document.getElementById('admin-add-email').value)" style="padding:0.45rem 1rem;border-radius:7px;background:#1a202c;color:#fff;border:none;font-family:'Noto Sans TC',sans-serif;font-size:0.82rem;cursor:pointer;white-space:nowrap;">æˆäºˆç·¨è¼¯</button>
        </div>
        <div id="admin-add-msg" style="font-size:0.75rem;margin-top:0.4rem;display:none;"></div>
      </div>
    </div>
    <div class="modal-footer" style="justify-content:flex-end;">
      <button class="btn-md c" onclick="closeAdminModal()">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- Login modal -->
<div class="modal-overlay login-modal" id="modal-login">
  <div class="modal" style="max-width:360px;">
    <div class="modal-header"><h3>æ•™è·å“¡ç™»å…¥</h3><button class="modal-close" onclick="closeLoginModal()">âœ•</button></div>
    <div class="modal-body">
      <p style="font-size:0.8rem;color:var(--text3);margin-bottom:1rem;line-height:1.7;">æ ¡å…§å¸³è™Ÿ <strong style="color:var(--text)">@sjps.kh.edu.tw</strong> ç™»å…¥å¾Œè‡ªå‹•å–å¾—ç·¨è¼¯æ¬Šé™<br>æ ¡å¤–å¸³è™Ÿç™»å…¥å¾Œåƒ…èƒ½ç€è¦½ï¼Œéœ€ç®¡ç†å“¡æ ¸å‡†æ‰èƒ½ç·¨è¼¯</p>
      <div class="form-msg" id="login-msg" style="margin-bottom:0.75rem;"></div>
    </div>
    <div class="modal-footer" style="flex-direction:column;align-items:stretch;gap:0.45rem;">
      <button onclick="handleGoogleLogin()" style="width:100%;padding:0.62rem;background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;gap:0.5rem;cursor:pointer;font-family:'Noto Sans TC',sans-serif;font-size:0.85rem;font-weight:500;transition:background .13s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='var(--surface2)'">
        <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
        ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
      </button>
    </div>
  </div>
</div>

<!-- Mobile FAB -->
<div class="mob-fab-area" id="mob-fab-area" style="display:none;">
  <div style="display:flex;flex-direction:column;align-items:center;">
    <button class="mob-fab mob-fab-add" id="mob-fab-add" style="display:none;" onclick="openAddModal(null)">ï¼‹</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, getDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyAhAduO-twiIX8kPUcXcwJDyuRCZT_GOZI",
  authDomain:"myproject-c52cb.firebaseapp.com",
  projectId:"myproject-c52cb",
  storageBucket:"myproject-c52cb.firebasestorage.app",
  messagingSenderId:"494432013878",
  appId:"1:494432013878:web:3c631ca98030600f915297"
});
const auth = getAuth(app);
const db = getFirestore(app);
const gProvider = new GoogleAuthProvider();
const DOMAIN = 'sjps.kh.edu.tw';
const SUPERADMIN = 'issac@sjps.kh.edu.tw';
const PERM_COL = 'permissions';
const COL = 'calendar_events';
const DEPTS = ['æ•™å‹™è™•','å­¸å‹™è™•','è¼”å°è™•','ç¸½å‹™è™•'];
const LOCATIONS = ['1Få¤§ç©¿å ‚','1Få°ç„é—œ','1Féœæ€æ›¸è»’','2Fæ ¡é•·å®¤æ—æœƒè­°å®¤','3Fè¦–è½æ•™å®¤','4Fåœ–æ›¸é¤¨','4Fæ¨‚æ´»æ•™å®¤','5Fæ´»å‹•ä¸­å¿ƒ','çƒå ´å—ä¸€ï¼ˆäºŒ.äº”.å…­å¹´ç´šï¼‰','çƒå ´å—äºŒï¼ˆäºŒ.äº”.å…­å¹´ç´šï¼‰','çƒå ´åŒ—ä¸€ï¼ˆä¸€.ä¸‰.å››å¹´ç´šï¼‰','çƒå ´åŒ—äºŒï¼ˆä¸€.ä¸‰.å››å¹´ç´šï¼‰','æ¡Œçƒæ•™å®¤','æŒ‡å®šç­ç´šæ•™å®¤','æ ¡å¤–'];
const BATCH_LOCS = ['', ...LOCATIONS];

// Taiwan public holidays (fixed annual + key ones for 2025/2026)
const TW_HOLIDAYS = {
  // Taiwan public holidays â€” only FIXED dates (not lunar-based)
  '01-01':'å…ƒæ—¦','02-28':'å’Œå¹³ç´€å¿µæ—¥','04-04':'å…’ç«¥ç¯€',
  '05-01':'å‹å‹•ç¯€','09-28':'æ•™å¸«ç¯€','10-10':'åœ‹æ…¶æ—¥',
  '12-25':'è¡Œæ†²ç´€å¿µæ—¥',
  // Lunar holidays by exact year (correct dates)
  '2025-01-28':'é™¤å¤•','2025-01-29':'æ˜¥ç¯€','2025-01-30':'æ˜¥ç¯€','2025-01-31':'æ˜¥ç¯€',
  '2025-05-31':'ç«¯åˆç¯€','2025-10-06':'ä¸­ç§‹ç¯€',
  // 2026 lunar
  '2026-02-16':'é™¤å¤•','2026-02-17':'æ˜¥ç¯€','2026-02-18':'æ˜¥ç¯€','2026-02-19':'æ˜¥ç¯€',
  '2026-06-20':'ç«¯åˆç¯€','2026-09-25':'ä¸­ç§‹ç¯€',
};

function getHolidayName(dateStr){
  if(TW_HOLIDAYS[dateStr]) return TW_HOLIDAYS[dateStr];
  const mmdd = dateStr.slice(5);
  return TW_HOLIDAYS[mmdd]||null;
}

let currentUser = null;
let canEdit = false;   // true if user has edit permission
let isAdmin = false;   // true if superadmin
let curYear = new Date().getFullYear();
let curMonth = new Date().getMonth();
let events = [];
let deptFilter = 'all';
let locFilter = 'all';
let editingId = null;
let dayModalDate = null;
let currentView = 'month';
let weekStartDate = null;

// â”€â”€ Header date â”€â”€
function initHeaderDate(){
  const d = new Date();
  const dow = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
  document.getElementById('header-date').textContent =
    `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆ${dow}ï¼‰`;
}
initHeaderDate();

// â”€â”€ Mobile detection â”€â”€
function isMobile(){ return window.innerWidth <= 640; }

function syncMobileUI(){
  const mob = isMobile();
  document.getElementById('mob-filter-row').style.display = mob ? 'flex' : 'none';
  document.getElementById('mob-fab-area').style.display = mob ? 'flex' : 'none';
  // Desktop sidebar visible only on non-mobile (CSS handles this too)
  const sidebar = document.getElementById('desktop-sidebar');
  if(sidebar) sidebar.style.display = mob ? 'none' : '';
}
syncMobileUI();
window.addEventListener('resize', syncMobileUI);

// Build mobile location grid
function buildMobLocGrid(){
  const grid = document.getElementById('mob-loc-grid');
  grid.innerHTML = '';
  // All button
  const allBtn = document.createElement('button');
  allBtn.className = 'mob-loc-item active'; allBtn.id = 'mlbtn-all';
  allBtn.textContent = 'å…¨éƒ¨';
  allBtn.onclick = () => { mobSetLoc('all'); };
  grid.appendChild(allBtn);
  LOCATIONS.forEach((loc, i) => {
    const btn = document.createElement('button');
    btn.className = 'mob-loc-item'; btn.id = 'mlbtn-' + loc;
    btn.innerHTML = `<span class="loc-dot ldot-${i%14}"></span>${loc}`;
    btn.onclick = () => mobSetLoc(loc);
    grid.appendChild(btn);
  });
}

// Mobile drawer open/close
window.openMobDrawer = (type) => {
  document.getElementById('mob-overlay').classList.add('open');
  document.getElementById('mob-drawer-dept').classList.toggle('open', type==='dept');
  document.getElementById('mob-drawer-loc').classList.toggle('open', type==='loc');
};
window.closeMobDrawer = () => {
  document.getElementById('mob-overlay').classList.remove('open');
  document.getElementById('mob-drawer-dept').classList.remove('open');
  document.getElementById('mob-drawer-loc').classList.remove('open');
};

// Mobile dept select
window.mobSetDept = (dept) => {
  setDeptFilter(dept); // reuse existing
  // Update mobile drawer buttons
  ['all','æ•™å‹™è™•','å­¸å‹™è™•','è¼”å°è™•','ç¸½å‹™è™•'].forEach(d => {
    const b = document.getElementById('mdbtn-'+d);
    if(!b) return;
    b.className = 'mob-dept-item';
    if(d===dept) b.className += ` active active-${d}`;
  });
  // Update pill label
  const dot = document.getElementById('mob-dept-dot');
  const label = document.getElementById('mob-dept-label');
  const deptBtn = document.getElementById('mob-dept-btn');
  if(dept==='all'){
    dot.style.background='#94a3b8'; label.textContent='è™•å®¤';
    deptBtn.classList.remove('has-filter');
  } else {
    const colors={æ•™å‹™è™•:'var(--æ•™å‹™è™•)',å­¸å‹™è™•:'var(--å­¸å‹™è™•)',è¼”å°è™•:'var(--è¼”å°è™•)',ç¸½å‹™è™•:'var(--ç¸½å‹™è™•)'};
    dot.style.background=colors[dept]||'#94a3b8'; label.textContent=dept;
    deptBtn.classList.add('has-filter');
  }
  closeMobDrawer();
};

// Mobile loc select
window.mobSetLoc = (loc) => {
  setLocFilter(loc); // reuse existing
  // Update mobile loc buttons
  document.querySelectorAll('.mob-loc-item').forEach(b => b.classList.remove('active'));
  const el = document.getElementById(loc==='all'?'mlbtn-all':'mlbtn-'+loc);
  if(el) el.classList.add('active');
  // Update pill
  const label = document.getElementById('mob-loc-label');
  const btn = document.getElementById('mob-loc-btn');
  if(loc==='all'){ label.textContent='åœ°é»'; btn.classList.remove('has-filter'); }
  else { label.textContent=loc.length>6?loc.slice(0,5)+'â€¦':loc; btn.classList.add('has-filter'); }
  closeMobDrawer();
};

// Show/hide add FAB based on login
function syncFAB(){
  const fab = document.getElementById('mob-fab-add');
  if(fab) fab.style.display = (currentUser && isMobile()) ? 'flex' : 'none';
}

buildMobLocGrid();

// â”€â”€ Quick nav (months + year) â”€â”€
function initQuickNav(){
  const yr = document.getElementById('year-select');
  const base = new Date().getFullYear();
  for(let y=base-2;y<=base+3;y++){
    const opt=document.createElement('option');
    opt.value=y; opt.textContent=y+'å¹´';
    if(y===base) opt.selected=true;
    yr.appendChild(opt);
  }
  const mb = document.getElementById('month-btns');
  for(let m=1;m<=12;m++){
    const btn=document.createElement('button');
    btn.className='qnav-btn';
    btn.id='mbtn-'+m;
    btn.textContent=m+'æœˆ';
    btn.onclick=()=>{ curMonth=m-1; renderView(); };
    mb.appendChild(btn);
  }
  updateQuickNav();
}
function updateQuickNav(){
  document.getElementById('year-select').value = curYear;
  for(let m=1;m<=12;m++){
    const b=document.getElementById('mbtn-'+m);
    if(b) b.className='qnav-btn'+(curMonth===m-1?' active':'');
  }
}
window.setYear = (y) => { curYear=parseInt(y); renderView(); };
initQuickNav();

// â”€â”€ Location bar â”€â”€
(function initLocBar(){
  // Desktop: horizontal button bar only
  const bar = document.getElementById('loc-bar');
  if(bar){
    LOCATIONS.forEach((loc,i)=>{
      const btn=document.createElement('button');
      btn.className='loc-bar-btn'; btn.id='locbtn-'+loc;
      btn.innerHTML=`<span class="loc-dot ldot-${(i+1)%14}"></span>${loc}`;
      btn.onclick=()=>setLocFilter(loc);
      bar.appendChild(btn);
    });
  }
  // Mobile loc grid is built by buildMobLocGrid() â€” do NOT duplicate here
})();

// â”€â”€ Filters â”€â”€
window.setDeptFilter=(dept)=>{
  deptFilter=dept;
  ['all','æ•™å‹™è™•','å­¸å‹™è™•','è¼”å°è™•','ç¸½å‹™è™•'].forEach(d=>{
    const btn=document.getElementById('dbtn-'+d);
    if(!btn) return;
    btn.className='dept-btn';
    if(d===dept) btn.className+=` active active-${d}`;
  });
  renderView();
  if(dayModalDate) renderDeptGrid(dayModalDate);
};

window.setLocFilter=(loc)=>{
  locFilter=loc;
  // Sync desktop loc-bar buttons
  document.querySelectorAll('.loc-bar-btn').forEach(b=>b.classList.remove('active'));
  const el=document.getElementById(loc==='all'?'locbtn-all':'locbtn-'+loc);
  if(el) el.classList.add('active');
  renderView();
  if(dayModalDate) renderDeptGrid(dayModalDate);
};

function passesFilter(ev){
  if(deptFilter!=='all'&&ev.dept!==deptFilter) return false;
  if(locFilter!=='all'&&ev.location!==locFilter) return false;
  return true;
}

// â”€â”€ Compensation holidays (è£œä¼‘/å½ˆæ€§å‡æ—¥) â”€â”€
// Stored in localStorage as a Set of date strings
let compDays = new Set(JSON.parse(localStorage.getItem('compDays')||'[]'));

function saveCompDays(){ localStorage.setItem('compDays', JSON.stringify([...compDays])); }

function isCompDay(ds){ return compDays.has(ds); }

function toggleCompDay(ds){
  if(compDays.has(ds)){ compDays.delete(ds); }
  else { compDays.add(ds); }
  saveCompDays();
  renderView();
}

// Long press detection for calendar cells
let longPressTimer = null;
let longPressTarget = null;

function attachLongPress(cell, ds){
  const DURATION = 5000; // 5 seconds, login required
  const start = (e) => {
    if(!currentUser||!canEdit) return; // must be logged in with edit permission
    longPressTarget = ds;
    longPressTimer = setTimeout(()=>{
      cell.style.transition = 'background 0.2s';
      cell.style.background = '#fde8e8';
      setTimeout(()=>{ cell.style.background=''; cell.style.transition=''; }, 500);
      toggleCompDay(ds);
      if(navigator.vibrate) navigator.vibrate(100);
    }, DURATION);
  };
  const cancel = () => { clearTimeout(longPressTimer); longPressTimer = null; };

  cell.addEventListener('mousedown', start);
  cell.addEventListener('touchstart', e=>{ e.preventDefault(); start(e); }, {passive:false});
  cell.addEventListener('mouseup', cancel);
  cell.addEventListener('mouseleave', cancel);
  cell.addEventListener('touchend', cancel);
  cell.addEventListener('touchcancel', cancel);
}

// â”€â”€ Conflict detection â”€â”€
function getConflicts(){
  const conflicts = new Set();
  for(let i=0;i<events.length;i++){
    for(let j=i+1;j<events.length;j++){
      const a=events[i], b=events[j];
      if(!a.location||!b.location||a.location!==b.location) continue;
      if(a.location==='æŒ‡å®šç­ç´šæ•™å®¤') continue;
      const aEnd=a.end||a.start, bEnd=b.end||b.start;
      if(a.start>bEnd||b.start>aEnd) continue;
      // Same date range overlap â€” check time if both have times
      if(a.stime&&b.stime&&a.etime&&b.etime){
        const sameDay = !(a.start>bEnd||b.start>aEnd);
        if(sameDay){
          if(a.stime>=b.etime||b.stime>=a.etime) continue;
        }
      }
      conflicts.add(a.id); conflicts.add(b.id);
    }
  }
  return conflicts;
}

// â”€â”€ Auth â”€â”€
// â”€â”€ Safety: force hide loading after 6 seconds no matter what â”€â”€
setTimeout(()=>{
  const l=document.getElementById('loading');
  if(l&&l.style.display!=='none'){
    l.style.display='none';
    if(!weekStartDate) weekStartDate=getWeekStart(new Date());
    renderView();
  }
},6000);

// â”€â”€ Permission helpers â”€â”€
async function checkAndSetPermission(user){
  const email = user.email;
  const domain = (email||'').split('@')[1];
  const permRef = doc(db, PERM_COL, email.replace(/\./g,'_'));

  // Superadmin
  if(email === SUPERADMIN){
    isAdmin = true; canEdit = true;
    // Ensure superadmin doc exists
    await setDoc(permRef, {email, role:'superadmin', grantedAt:serverTimestamp()}, {merge:true});
    return;
  }

  // School domain â†’ auto editor
  if(domain === DOMAIN){
    canEdit = true; isAdmin = false;
    await setDoc(permRef, {email, role:'editor', domain:DOMAIN, grantedAt:serverTimestamp()}, {merge:true});
    return;
  }

  // External user â†’ check Firestore for approval
  const snap = await getDoc(permRef);
  if(snap.exists() && snap.data().role === 'editor'){
    canEdit = true; isAdmin = false;
  } else {
    canEdit = false; isAdmin = false;
    // Register as pending if not already
    if(!snap.exists()){
      await setDoc(permRef, {email, role:'pending', requestedAt:serverTimestamp()});
    }
  }
}

function applyUIPermissions(){
  const showEdit = canEdit;
  const showAdmin = isAdmin;
  document.getElementById('btn-add-header').style.display = showEdit ? '' : 'none';
  document.getElementById('btn-batch').style.display = showEdit ? '' : 'none';
  document.getElementById('btn-admin').style.display = showAdmin ? '' : 'none';
  document.getElementById('add-btn-side').style.display = showEdit ? 'block' : 'none';
  const mbb = document.getElementById('mob-batch-btn');
  if(mbb) mbb.style.display = showEdit ? '' : 'none';
  syncFAB();
}

onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser = user;
    await checkAndSetPermission(user);
    document.getElementById('user-info').style.display='flex';
    document.getElementById('user-email-show').textContent=user.email.split('@')[0];
    document.getElementById('btn-logout').style.display='';
    document.getElementById('btn-login-open').style.display='none';
    applyUIPermissions();

    // Show pending notice for external viewers
    if(!canEdit && !isAdmin){
      showFMsg('login-msg','','âœ… å·²ç™»å…¥ï¼ˆåƒ…ç€è¦½ï¼‰â€” ç·¨è¼¯æ¬Šé™å¾…ç®¡ç†å“¡æ ¸å‡†');
    }
    closeLoginModal();
  } else {
    currentUser = null; canEdit = false; isAdmin = false;
    document.getElementById('user-info').style.display='none';
    document.getElementById('btn-logout').style.display='none';
    document.getElementById('btn-login-open').style.display='';
    document.getElementById('btn-add-header').style.display='none';
    document.getElementById('btn-batch').style.display='none';
    document.getElementById('btn-admin').style.display='none';
    document.getElementById('add-btn-side').style.display='none';
    const mbb = document.getElementById('mob-batch-btn');
    if(mbb) mbb.style.display='none';
    syncFAB();
  }
  document.getElementById('loading').style.display='none';
  if(!weekStartDate) weekStartDate=getWeekStart(new Date());
  renderView();
  if(dayModalDate) renderDeptGrid(dayModalDate);
  updateTicker();
});

// â”€â”€ Firestore â”€â”€
// Use collection snapshot without orderBy to avoid needing a Firestore index
onSnapshot(collection(db,COL),snap=>{
  events=snap.docs.map(d=>({id:d.id,...d.data()}));
  // Sort client-side
  events.sort((a,b)=>(a.start||'').localeCompare(b.start||''));
  document.getElementById('loading').style.display='none';
  renderView();
  if(dayModalDate) renderDeptGrid(dayModalDate);
  updateTicker();
},err=>{
  console.error('Firestore error:',err);
  document.getElementById('loading').style.display='none';
  if(!weekStartDate) weekStartDate=getWeekStart(new Date());
  renderView();
});

// â”€â”€ Helpers â”€â”€
function pad(n){return String(n).padStart(2,'0');}
function toDS(date){return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`;}
function dowCh(n){return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][n];}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');}
function fmtMonthLabel(d){return `${d.getFullYear()} å¹´ ${d.getMonth()+1} æœˆ`;}
function getWeekStart(date){const d=new Date(date);d.setHours(0,0,0,0);d.setDate(d.getDate()-d.getDay());return d;}

// â”€â”€ Ticker (today's events) â”€â”€
function updateTicker(){
  const todayStr = toDS(new Date());
  const todayEvs = events.filter(ev=>{
    const end=ev.end||ev.start;
    return todayStr>=ev.start&&todayStr<=end;
  });
  const ticker = document.getElementById('header-ticker');
  if(!todayEvs.length){ ticker.innerHTML='<span class="ticker-empty">ä»Šæ—¥ç„¡æ´»å‹•</span>'; return; }
  if(todayEvs.length===1){
    const ev=todayEvs[0];
    ticker.innerHTML=`<span class="ticker-item"><span class="ticker-dot dot-${ev.dept}" style="background:var(--${ev.dept})"></span>${ev.stime?ev.stime+' ':''}<strong>${ev.title}</strong>${ev.location?' @ '+ev.location:''}</span>`;
    return;
  }
  // Marquee for multiple
  const items=todayEvs.map(ev=>`<span class="ticker-item"><span class="ticker-dot" style="background:var(--${ev.dept});width:7px;height:7px;border-radius:50%;display:inline-block;"></span>${ev.stime?ev.stime+' ':''}<strong>${ev.title}</strong>${ev.location?' @ '+ev.location:''}</span>`).join('<span style="margin:0 1rem;color:var(--text3);">Â·</span>');
  ticker.innerHTML=`<div class="ticker-inner">${items}</div>`;
}

// â”€â”€ View control â”€â”€
function renderView(){
  updateQuickNav();
  if(currentView==='month') renderCalendar();
  else renderWeekView();
}

window.setView=(view)=>{
  currentView=view;
  document.getElementById('view-month').style.display=view==='month'?'':'none';
  document.getElementById('view-week').style.display=view==='week'?'':'none';
  document.getElementById('view-btn-month').className=view==='month'?'active':'';
  document.getElementById('view-btn-week').className=view==='week'?'active':'';
  renderView();
};

window.navPrev=()=>{
  if(currentView==='month'){curMonth--;if(curMonth<0){curMonth=11;curYear--;}}
  else{weekStartDate.setDate(weekStartDate.getDate()-7);}
  renderView();
};
window.navNext=()=>{
  if(currentView==='month'){curMonth++;if(curMonth>11){curMonth=0;curYear++;}}
  else{weekStartDate.setDate(weekStartDate.getDate()+7);}
  renderView();
};
window.goToday=()=>{
  curYear=new Date().getFullYear();curMonth=new Date().getMonth();
  weekStartDate=getWeekStart(new Date());
  renderView();
};

// â”€â”€ Month calendar â”€â”€
function renderCalendar(){
  const label=`${curYear} å¹´ ${curMonth+1} æœˆ`;
  document.getElementById('cal-month-label').textContent=label;
  const firstDow=new Date(curYear,curMonth,1).getDay();
  const daysInMonth=new Date(curYear,curMonth+1,0).getDate();
  const prevTotal=new Date(curYear,curMonth,0).getDate();
  const today=new Date(); const todayStr=toDS(today);
  const conflicts=getConflicts();
  const container=document.getElementById('cal-days');
  container.innerHTML='';

  for(let i=firstDow-1;i>=0;i--)
    container.appendChild(makeCell(new Date(curYear,curMonth-1,prevTotal-i),true,conflicts));
  for(let d=1;d<=daysInMonth;d++)
    container.appendChild(makeCell(new Date(curYear,curMonth,d),false,conflicts));
  const total=firstDow+daysInMonth;
  const rem=total%7===0?0:7-(total%7);
  for(let d=1;d<=rem;d++)
    container.appendChild(makeCell(new Date(curYear,curMonth+1,d),true,conflicts));
}

function makeCell(date,otherMonth,conflicts){
  const ds=toDS(date); const dow=date.getDay();
  const isToday=ds===toDS(new Date());
  const holiday=!otherMonth?getHolidayName(ds):null;
  const isComp=!otherMonth&&isCompDay(ds);
  const isWeekend=dow===0||dow===6;

  const cell=document.createElement('div');
  cell.className='cal-day'
    +(otherMonth?' other-month':'')
    +(isToday?' today':'')
    +(!otherMonth&&(isWeekend||isComp)&&!holiday?' weekend':'')
    +(!otherMonth&&(holiday||isComp)?' holiday':'')
    +(dow===0&&!otherMonth?' sunday':'')
    +(dow===6&&!otherMonth?' saturday':'');
  cell.onclick=()=>openDayModal(ds);

  // Attach long-press to toggle comp day
  if(!otherMonth) attachLongPress(cell, ds);

  // Day number row
  const numWrap=document.createElement('div');
  numWrap.className='day-num-wrap';
  const numEl=document.createElement('div');
  numEl.className='day-num';
  numEl.textContent=date.getDate();
  numWrap.appendChild(numEl);
  if(holiday&&!otherMonth){
    const hn=document.createElement('span');
    hn.className='holiday-name';
    hn.textContent=holiday;
    numWrap.appendChild(hn);
  } else if(isComp){
    const hn=document.createElement('span');
    hn.className='holiday-name';
    hn.textContent='è£œä¼‘';
    numWrap.appendChild(hn);
  }
  cell.appendChild(numWrap);

  // Events
  const dayEvs=events.filter(ev=>{
    if(!passesFilter(ev)) return false;
    const end=ev.end||ev.start;
    return ds>=ev.start&&ds<=end;
  });
  const evWrap=document.createElement('div');
  evWrap.className='day-events';
  const mob=isMobile();
  // Fixed cell: 120px total, ~36px for date row â†’ ~84px for events
  // Each chip ~20px + 1px gap. Reserve ~14px for "+N more" chip
  // So max chips = floor((84 - 14) / 21) = 3 on desktop
  const MAX=mob?2:3;
  dayEvs.slice(0,MAX).forEach(ev=>{
    const chip=document.createElement('div');
    const hasConflict=conflicts.has(ev.id);
    chip.className=`event-chip bg-${ev.dept}`+(hasConflict?' chip-conflict':'');
    chip.onclick=e=>{e.stopPropagation();openDayModal(ds);};

    if(mob){
      chip.textContent=ev.title.length>2?ev.title.slice(0,2)+'â€¦':ev.title;
    } else {
      // Title first â€” takes all available space, ellipsis if overflow
      const ti=document.createElement('span');
      ti.className='chip-title';
      ti.textContent=ev.title;
      chip.appendChild(ti);
      // Time â€” small, right-aligned, only show start time (no end time to save space)
      if(ev.stime){
        const t=document.createElement('span');
        t.className='chip-time';
        t.textContent=ev.stime;
        chip.appendChild(t);
      }
      // Location dot only (no text) to save space
      if(ev.location){
        const lo=document.createElement('span');
        lo.className='chip-loc';
        lo.textContent='ğŸ“'+ev.location;
        chip.appendChild(lo);
      }
    }
    evWrap.appendChild(chip);
  });
  if(dayEvs.length>MAX){
    const more=document.createElement('div');
    more.className='more-chip';
    const extra=dayEvs.length-MAX;
    more.textContent=mob?`+${extra}`:`+${extra} ç­†`;
    more.onclick=e=>{e.stopPropagation();openDayModal(ds);};
    evWrap.appendChild(more);
  }
  cell.appendChild(evWrap);
  return cell;
}

// â”€â”€ Week view (4-column, one per dept) â”€â”€
function renderWeekView(){
  if(!weekStartDate) weekStartDate=getWeekStart(new Date());
  const endDate=new Date(weekStartDate); endDate.setDate(endDate.getDate()+27);
  const sl=fmtMonthLabel(weekStartDate); const el=fmtMonthLabel(endDate);
  document.getElementById('cal-month-label').textContent=sl===el?sl:sl+' â€“ '+el;

  const container=document.getElementById('week-4col');
  container.innerHTML='';
  const todayStr=toDS(new Date());
  const conflicts=getConflicts();

  DEPTS.forEach(dept=>{
    const col=document.createElement('div');
    col.className='week-dept-col';

    const hdr=document.createElement('div');
    hdr.className=`week-dept-header soft-${dept}`;
    hdr.innerHTML=`<span class="d-dot dot-${dept}"></span>${dept}`;
    col.appendChild(hdr);

    const body=document.createElement('div');
    body.className='week-dept-body';

    for(let w=0;w<4;w++){
      // Week separator
      const wStart=new Date(weekStartDate); wStart.setDate(wStart.getDate()+w*7);
      const wEnd=new Date(wStart); wEnd.setDate(wEnd.getDate()+6);
      const wLabel=document.createElement('div');
      wLabel.style.cssText='font-size:0.65rem;color:var(--text3);padding:0.3rem 0.25rem 0.15rem;letter-spacing:.04em;font-weight:600;border-top:1px solid var(--border);margin-top:2px;';
      if(w===0) wLabel.style.borderTop='none';
      wLabel.textContent=`${wStart.getMonth()+1}/${wStart.getDate()}â€“${wEnd.getMonth()+1}/${wEnd.getDate()}`;
      body.appendChild(wLabel);

      for(let d=0;d<7;d++){
        const date=new Date(wStart); date.setDate(date.getDate()+d);
        const ds=toDS(date); const dow=date.getDay();
        const isToday=ds===todayStr;
        const holiday=getHolidayName(ds);
        const isComp=isCompDay(ds);
        const isWeekend=dow===0||dow===6;

        const dayRow=document.createElement('div');
        dayRow.className='week-day-row'
          +(isToday?' is-today':'')
          +((isWeekend||isComp)&&!holiday?' weekend-row':'')
          +((holiday||isComp)?' holiday-row':'');
        dayRow.onclick=()=>openDayModal(ds);

        const dateLine=document.createElement('div');
        dateLine.className='week-date-line';
        const numEl=document.createElement('div');
        numEl.className='week-day-num'+(dow===0?' '+(isToday?'':''):'');
        numEl.style.color=dow===0?'#ef4444':dow===6?'#3b82f6':'';
        numEl.textContent=date.getDate();
        const dowEl=document.createElement('div');
        dowEl.className='week-dow';
        dowEl.textContent=dowCh(dow);
        dateLine.appendChild(numEl);
        dateLine.appendChild(dowEl);
        if(holiday||isComp){
          const hl=document.createElement('div');
          hl.className='week-holiday-name';
          hl.textContent=holiday||(isComp?'è£œä¼‘':'');
          dateLine.appendChild(hl);
        }
        dayRow.appendChild(dateLine);

        const evs=events.filter(ev=>{
          if(ev.dept!==dept) return false;
          if(locFilter!=='all'&&ev.location!==locFilter) return false;
          const end=ev.end||ev.start;
          return ds>=ev.start&&ds<=end;
        });

        if(evs.length>0){
          const evDiv=document.createElement('div');
          evDiv.className='week-events';
          evs.forEach(ev=>{
            const pill=document.createElement('div');
            const hasConflict=conflicts.has(ev.id);
            pill.className=`week-ev-pill bg-${ev.dept}`;
            pill.style.position='relative';
            let html='';
            if(ev.stime) html+=`<div class="week-ev-time">${ev.stime}${ev.etime?'â€“'+ev.etime:''}</div>`;
            html+=`<div style="font-weight:600;font-size:0.74rem;">${esc(ev.title)}</div>`;
            if(ev.location) html+=`<div class="week-ev-loc">ğŸ“${esc(ev.location)}</div>`;
            if(hasConflict) html+=`<span style="position:absolute;top:-4px;right:-4px;font-size:0.65rem;background:#f59e0b;color:#fff;border-radius:50%;width:14px;height:14px;display:flex;align-items:center;justify-content:center;">âš </span>`;
            pill.innerHTML=html;
            pill.onclick=e=>{e.stopPropagation();openDayModal(ds);};
            evDiv.appendChild(pill);
          });
          dayRow.appendChild(evDiv);
        }
        body.appendChild(dayRow);
      }
    }
    col.appendChild(body);
    container.appendChild(col);
  });
}

// â”€â”€ Day Modal â”€â”€
window.openDayModal=(ds)=>{
  dayModalDate=ds;
  const d=new Date(ds);
  const holiday=getHolidayName(ds);
  const isComp=isCompDay(ds);
  document.getElementById('day-hdr-title').textContent=
    `${d.getFullYear()} å¹´ ${d.getMonth()+1} æœˆ ${d.getDate()} æ—¥ï¼ˆ${dowCh(d.getDay())}ï¼‰`
    +(holiday?` â”€ ${holiday}`:isComp?' â”€ è£œä¼‘æ—¥':'');
  renderDeptGrid(ds);
  document.getElementById('add-day-btn').style.display=canEdit?'inline-flex':'none';
  const compBtn=document.getElementById('comp-day-btn');
  if(compBtn){
    compBtn.style.display=canEdit?'':'none';
    compBtn.textContent=isComp?'ğŸ—“ å–æ¶ˆè£œä¼‘æ—¥':'ğŸ—“ è¨­ç‚ºè£œä¼‘æ—¥';
    compBtn.style.background=isComp?'#fef3c7':'#fff5f5';
    compBtn.style.borderColor=isComp?'#fbbf24':'#fca5a5';
    compBtn.style.color=isComp?'#92400e':'#dc2626';
  }
  document.getElementById('modal-day').classList.add('open');
};

window.toggleCompDayFromModal=()=>{
  if(!dayModalDate) return;
  toggleCompDay(dayModalDate);
  // Refresh modal
  openDayModal(dayModalDate);
};

function renderDeptGrid(ds){
  const grid=document.getElementById('dept-grid');
  grid.innerHTML='';
  const dayEvs=events.filter(ev=>{const end=ev.end||ev.start;return ds>=ev.start&&ds<=end;});
  const conflicts=getConflicts();

  DEPTS.forEach(dept=>{
    const col=document.createElement('div');
    col.className='dept-col';
    const hdr=document.createElement('div');
    hdr.className=`dept-col-header soft-${dept}`;
    hdr.innerHTML=`<span class="d-dot dot-${dept}"></span>${dept}`;
    col.appendChild(hdr);
    const body=document.createElement('div');
    body.className='dept-col-body';
    const dEvs=dayEvs.filter(e=>e.dept===dept);
    if(!dEvs.length){
      body.innerHTML='<div class="dept-empty">â€”</div>';
    } else {
      dEvs.forEach(ev=>{
        const hasConflict=conflicts.has(ev.id);
        const item=document.createElement('div');
        item.className='dept-ev-item'+(hasConflict?' conflict-item':'');
        const dateRange=ev.end&&ev.end!==ev.start?`${ev.start}ï½${ev.end}`:ev.start;
        const timeStr=(ev.stime||ev.etime)?`ğŸ• ${ev.stime||''}${ev.etime?' â€“ '+ev.etime:''}`:'';
        item.innerHTML=`
          ${hasConflict?`<div class="conflict-badge">âš  åœ°é»è¡çª</div>`:''}
          <div class="dept-ev-title">${esc(ev.title)}</div>
          <div class="dept-ev-meta">
            <span>ğŸ“… ${dateRange}</span>
            ${timeStr?`<span>${timeStr}</span>`:''}
            ${ev.location?`<span>ğŸ“ ${esc(ev.location)}</span>`:''}
          </div>
          ${ev.note?`<div style="font-size:0.7rem;color:var(--text3);margin-top:0.2rem;">ğŸ“ ${esc(ev.note)}</div>`:''}
          ${canEdit?`<div class="dept-ev-actions">
            <button class="btn-xs e" onclick="openEditEvent('${ev.id}')">ç·¨è¼¯</button>
            <button class="btn-xs d" onclick="confirmDelete('${ev.id}')">åˆªé™¤</button>
          </div>`:''}
        `;
        body.appendChild(item);
      });
    }
    col.appendChild(body);
    grid.appendChild(col);
  });
}

window.closeDayModal=()=>{document.getElementById('modal-day').classList.remove('open');dayModalDate=null;};
window.addFromDay=()=>{const d=dayModalDate;closeDayModal();openAddModal(d);};

// â”€â”€ Add/Edit â”€â”€
window.openAddModal=(ds)=>{
  if(!canEdit) return;
  editingId=null;
  document.getElementById('add-modal-title').textContent='æ–°å¢æ´»å‹•';
  document.getElementById('ev-title').value='';
  document.getElementById('ev-start').value=ds||'';
  document.getElementById('ev-end').value=ds||'';
  document.getElementById('ev-stime').value='';
  document.getElementById('ev-etime').value='';
  document.getElementById('ev-location').value='';
  document.getElementById('ev-dept').value='æ•™å‹™è™•';
  document.getElementById('ev-note').value='';
  document.getElementById('btn-del-ev').style.display='none';
  clearFMsg('add-msg');
  document.getElementById('modal-add').classList.add('open');
};

window.openEditEvent=(id)=>{
  const ev=events.find(e=>e.id===id);
  if(!ev||!canEdit) return;
  editingId=id;
  document.getElementById('add-modal-title').textContent='ç·¨è¼¯æ´»å‹•';
  document.getElementById('ev-title').value=ev.title||'';
  document.getElementById('ev-start').value=ev.start||'';
  document.getElementById('ev-end').value=ev.end||ev.start||'';
  document.getElementById('ev-stime').value=ev.stime||'';
  document.getElementById('ev-etime').value=ev.etime||'';
  document.getElementById('ev-location').value=ev.location||'';
  document.getElementById('ev-dept').value=ev.dept||'æ•™å‹™è™•';
  document.getElementById('ev-note').value=ev.note||'';
  document.getElementById('btn-del-ev').style.display='';
  clearFMsg('add-msg');
  document.getElementById('modal-add').classList.add('open');
};

window.closeAddModal=()=>{document.getElementById('modal-add').classList.remove('open');editingId=null;};

window.handleSaveEvent=async()=>{
  const title=document.getElementById('ev-title').value.trim();
  const start=document.getElementById('ev-start').value;
  const end=document.getElementById('ev-end').value||start;
  const stime=document.getElementById('ev-stime').value;
  const etime=document.getElementById('ev-etime').value;
  const location=document.getElementById('ev-location').value;
  const dept=document.getElementById('ev-dept').value;
  const note=document.getElementById('ev-note').value.trim();
  if(!title) return showFMsg('add-msg','','è«‹å¡«å¯«æ´»å‹•åç¨±');
  if(!start) return showFMsg('add-msg','','è«‹é¸æ“‡é–‹å§‹æ—¥æœŸ');
  if(!end) return showFMsg('add-msg','','è«‹é¸æ“‡çµæŸæ—¥æœŸ');
  if(!location) return showFMsg('add-msg','','è«‹é¸æ“‡åœ°é»æˆ–æ•™å®¤');
  if(end<start) return showFMsg('add-msg','','çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ');
  const btn=document.getElementById('btn-save-ev');
  btn.disabled=true;btn.textContent='å„²å­˜ä¸­â€¦';
  try{
    const payload={title,start,end,stime,etime,location,dept,note,createdBy:currentUser.email,updatedAt:serverTimestamp()};
    if(editingId){ await updateDoc(doc(db,COL,editingId),payload); }
    else{ payload.createdAt=serverTimestamp(); await addDoc(collection(db,COL),payload); }
    closeAddModal();
  }catch(e){showFMsg('add-msg','','å„²å­˜å¤±æ•—ï¼š'+e.message);}
  btn.disabled=false;btn.textContent='å„²å­˜';
};

window.handleDeleteEvent=async()=>{
  if(!editingId||!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
  await deleteDoc(doc(db,COL,editingId));
  closeAddModal();
};

window.confirmDelete=async(id)=>{
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ´»å‹•å—ï¼Ÿ')) return;
  await deleteDoc(doc(db,COL,id));
};

// â”€â”€ Login (Google only) â”€â”€
function showFMsg(id,cls,text){const el=document.getElementById(id);el.className='form-msg '+cls;el.textContent=text;el.style.display='block';}
function clearFMsg(id){const el=document.getElementById(id);el.style.display='none';el.textContent='';}

window.openLoginModal=()=>{clearFMsg('login-msg');document.getElementById('modal-login').classList.add('open');};
window.closeLoginModal=()=>document.getElementById('modal-login').classList.remove('open');

window.handleGoogleLogin=async()=>{
  try{
    await signInWithPopup(auth,gProvider);
    // Permission check happens in onAuthStateChanged
  }catch(e){if(e.code!=='auth/popup-closed-by-user') showFMsg('login-msg','','Google ç™»å…¥å¤±æ•—');}
};

window.handleLogout=()=>signOut(auth);

// â”€â”€ Admin Modal â”€â”€
window.openAdminModal=async()=>{
  if(!isAdmin) return;
  document.getElementById('modal-admin').classList.add('open');
  await loadAdminData();
};
window.closeAdminModal=()=>document.getElementById('modal-admin').classList.remove('open');

async function loadAdminData(){
  const pendingDiv=document.getElementById('admin-pending');
  const editorsDiv=document.getElementById('admin-editors');
  pendingDiv.innerHTML='<div style="font-size:0.78rem;color:var(--text3);">è¼‰å…¥ä¸­â€¦</div>';
  editorsDiv.innerHTML='<div style="font-size:0.78rem;color:var(--text3);">è¼‰å…¥ä¸­â€¦</div>';

  try{
    const snap=await getDocs(collection(db,PERM_COL));
    const pending=[], editors=[];
    snap.forEach(d=>{
      const data=d.data();
      if(data.email===SUPERADMIN) return; // skip superadmin
      if(data.role==='pending') pending.push(data);
      else if(data.role==='editor') editors.push(data);
    });

    // Render pending
    if(!pending.length){
      pendingDiv.innerHTML='<div style="font-size:0.78rem;color:var(--text3);">æ²’æœ‰å¾…å¯©æ ¸å¸³è™Ÿ</div>';
    } else {
      pendingDiv.innerHTML=pending.map(u=>`
        <div style="display:flex;align-items:center;gap:0.5rem;padding:0.45rem 0.6rem;background:var(--surface2);border-radius:8px;border:1px solid var(--border);">
          <div style="flex:1;">
            <div style="font-size:0.82rem;font-weight:600;">${u.email}</div>
            <div style="font-size:0.7rem;color:var(--text3);">ç”³è«‹æ™‚é–“ï¼š${u.requestedAt?.toDate ? u.requestedAt.toDate().toLocaleDateString('zh-TW') : 'â€”'}</div>
          </div>
          <button onclick="adminGrantEditor('${u.email}')" style="padding:0.28rem 0.7rem;border-radius:6px;background:#059669;color:#fff;border:none;font-size:0.76rem;cursor:pointer;font-family:'Noto Sans TC',sans-serif;">âœ“ æ ¸å‡†</button>
          <button onclick="adminRevokeUser('${u.email}')" style="padding:0.28rem 0.7rem;border-radius:6px;background:#fee2e2;color:#dc2626;border:none;font-size:0.76rem;cursor:pointer;font-family:'Noto Sans TC',sans-serif;">âœ• æ‹’çµ•</button>
        </div>`).join('');
    }

    // Render editors
    if(!editors.length){
      editorsDiv.innerHTML='<div style="font-size:0.78rem;color:var(--text3);">æ²’æœ‰å·²æ ¸å‡†çš„å¤–éƒ¨å¸³è™Ÿ</div>';
    } else {
      editorsDiv.innerHTML=editors.map(u=>`
        <div style="display:flex;align-items:center;gap:0.5rem;padding:0.45rem 0.6rem;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0;">
          <div style="flex:1;">
            <div style="font-size:0.82rem;font-weight:600;">${u.email}</div>
            <div style="font-size:0.7rem;color:var(--text3);">${u.domain===DOMAIN?'æ ¡å…§å¸³è™Ÿ':'å¤–éƒ¨å¸³è™Ÿ'}</div>
          </div>
          ${u.domain!==DOMAIN?`<button onclick="adminRevokeUser('${u.email}')" style="padding:0.28rem 0.7rem;border-radius:6px;background:#fee2e2;color:#dc2626;border:none;font-size:0.76rem;cursor:pointer;font-family:'Noto Sans TC',sans-serif;">æ’¤éŠ·</button>`:''}
        </div>`).join('');
    }
  }catch(e){
    pendingDiv.innerHTML='<div style="font-size:0.78rem;color:#ef4444;">è¼‰å…¥å¤±æ•—</div>';
  }
}

window.adminGrantEditor=async(email)=>{
  if(!email||!email.includes('@')){ showAdminMsg('è«‹è¼¸å…¥æœ‰æ•ˆçš„ email','#ef4444'); return; }
  email=email.trim().toLowerCase();
  const key=email.replace(/\./g,'_');
  try{
    await setDoc(doc(db,PERM_COL,key),{
      email, role:'editor',
      approvedBy:currentUser.email, approvedAt:serverTimestamp()
    },{merge:true});
    document.getElementById('admin-add-email').value='';
    showAdminMsg(`âœ… å·²æˆäºˆ ${email} ç·¨è¼¯æ¬Šé™`,'#059669');
    await loadAdminData();
  }catch(e){ showAdminMsg('æ“ä½œå¤±æ•—ï¼š'+e.message,'#ef4444'); }
};

window.adminRevokeUser=async(email)=>{
  if(!confirm(`ç¢ºå®šè¦ç§»é™¤ ${email} çš„æ¬Šé™ï¼Ÿ`)) return;
  const key=email.replace(/\./g,'_');
  try{
    await setDoc(doc(db,PERM_COL,key),{email,role:'revoked',revokedAt:serverTimestamp()},{merge:true});
    await loadAdminData();
  }catch(e){ alert('æ“ä½œå¤±æ•—ï¼š'+e.message); }
};

function showAdminMsg(msg,color){
  const el=document.getElementById('admin-add-msg');
  el.textContent=msg; el.style.color=color; el.style.display='block';
  setTimeout(()=>el.style.display='none',3500);
}

// â”€â”€ Batch Manager â”€â”€
let batchRows=[], parsedRows=[], csvRows=[];

window.openBatchModal=()=>{
  batchRows=events.map(e=>({...e,dirty:false,isNew:false}));
  batchRows.sort((a,b)=>(a.start||'').localeCompare(b.start||''));
  renderBatchTable();
  document.getElementById('modal-batch').classList.add('open');
  switchBatchTab('table');
};
window.closeBatchModal=()=>document.getElementById('modal-batch').classList.remove('open');

window.switchBatchTab=(tab)=>{
  ['table','paste','csv'].forEach(t=>{
    document.getElementById('btab-'+t).className='batch-tab'+(t===tab?' active':'');
    document.getElementById('batch-panel-'+t).style.display=t===tab?'flex':'none';
  });
};

window.renderBatchTable=()=>{
  const fd=document.getElementById('table-filter-dept').value;
  const tbody=document.getElementById('batch-tbody');
  tbody.innerHTML='';
  const visible=fd==='all'?batchRows:batchRows.filter(r=>r.dept===fd);
  visible.forEach((row,i)=>{
    const tr=document.createElement('tr');
    tr.className='batch-tbody-row'+(row.isNew?' batch-row-new':'');
    const deptOpts=DEPTS.map(d=>`<option value="${d}" ${row.dept===d?'selected':''}>${d}</option>`).join('');
    const locOpts=BATCH_LOCS.map(l=>`<option value="${l}" ${row.location===l?'selected':''}>${l||'ï¼ˆæœªå¡«ï¼‰'}</option>`).join('');
    const dc=row.dirty?' dirty':'';
    tr.innerHTML=`
      <td class="batch-cell" style="color:var(--text3);font-size:0.73rem;text-align:center;">${i+1}</td>
      <td class="batch-cell" style="min-width:150px;"><input class="batch-input${dc}" value="${esc(row.title||'')}" placeholder="æ´»å‹•åç¨±" onchange="markDirty('${row.id}',this,'title')" oninput="markDirty('${row.id}',this,'title')"></td>
      <td class="batch-cell" style="min-width:115px;"><input class="batch-input${dc}" type="date" value="${row.start||''}" onchange="markDirty('${row.id}',this,'start')"></td>
      <td class="batch-cell" style="min-width:115px;"><input class="batch-input${dc}" type="date" value="${row.end||row.start||''}" onchange="markDirty('${row.id}',this,'end')"></td>
      <td class="batch-cell" style="min-width:85px;"><input class="batch-input${dc}" type="time" value="${row.stime||''}" onchange="markDirty('${row.id}',this,'stime')"></td>
      <td class="batch-cell" style="min-width:85px;"><input class="batch-input${dc}" type="time" value="${row.etime||''}" onchange="markDirty('${row.id}',this,'etime')"></td>
      <td class="batch-cell" style="min-width:155px;"><select class="batch-select${dc}" onchange="markDirty('${row.id}',this,'location')">${locOpts}</select></td>
      <td class="batch-cell" style="min-width:85px;"><select class="batch-select${dc}" onchange="markDirty('${row.id}',this,'dept')">${deptOpts}</select></td>
      <td class="batch-cell" style="min-width:135px;"><input class="batch-input${dc}" value="${esc(row.note||'')}" placeholder="å‚™è¨»" onchange="markDirty('${row.id}',this,'note')" oninput="markDirty('${row.id}',this,'note')"></td>
      <td class="batch-cell" style="text-align:center;">
        <button onclick="deleteBatchRow('${row.id}')" style="background:#fee2e2;color:#dc2626;border:none;border-radius:4px;padding:0.2rem 0.45rem;cursor:pointer;font-size:0.72rem;">åˆªé™¤</button>
      </td>`;
    tbody.appendChild(tr);
  });
};

window.markDirty=(id,el,field)=>{
  const row=batchRows.find(r=>r.id===id);
  if(!row) return;
  row[field]=el.value; row.dirty=true; el.classList.add('dirty');
};

window.addBatchRow=()=>{
  const fd=document.getElementById('table-filter-dept').value;
  const tmpId='new-'+Date.now();
  batchRows.push({id:tmpId,title:'',start:'',end:'',stime:'',etime:'',location:'',dept:fd==='all'?'æ•™å‹™è™•':fd,note:'',dirty:true,isNew:true});
  renderBatchTable();
  const t=document.querySelector('#batch-panel-table > div:last-child');
  if(t) t.scrollTop=t.scrollHeight;
};

window.deleteBatchRow=async(id)=>{
  const row=batchRows.find(r=>r.id===id);
  if(!row) return;
  if(row.isNew){batchRows=batchRows.filter(r=>r.id!==id);renderBatchTable();return;}
  if(!confirm('ç¢ºå®šåˆªé™¤ã€Œ'+row.title+'ã€ï¼Ÿ')) return;
  await deleteDoc(doc(db,COL,id));
  batchRows=batchRows.filter(r=>r.id!==id);
  renderBatchTable();
};

window.saveBatchTable=async()=>{
  const dirty=batchRows.filter(r=>r.dirty);
  if(!dirty.length){showBatchMsg('table','æ²’æœ‰éœ€è¦å„²å­˜çš„è®Šæ›´');return;}
  const btn=document.getElementById('btn-save-batch-table');
  btn.disabled=true;btn.textContent='å„²å­˜ä¸­â€¦';
  let saved=0,failed=0;
  for(const row of dirty){
    if(!row.title||!row.start){failed++;continue;}
    const payload={title:row.title,start:row.start,end:row.end||row.start,stime:row.stime||'',etime:row.etime||'',location:row.location||'',dept:row.dept||'æ•™å‹™è™•',note:row.note||'',createdBy:currentUser.email,updatedAt:serverTimestamp()};
    try{
      if(row.isNew){payload.createdAt=serverTimestamp();const ref=await addDoc(collection(db,COL),payload);row.id=ref.id;row.isNew=false;}
      else{await updateDoc(doc(db,COL,row.id),payload);}
      row.dirty=false;saved++;
    }catch(e){failed++;}
  }
  btn.disabled=false;btn.textContent='ğŸ’¾ å…¨éƒ¨å„²å­˜';
  showBatchMsg('table',`âœ… å·²å„²å­˜ ${saved} ç­†${failed?`ï¼Œ${failed} ç­†å¤±æ•—`:''}`);
  renderBatchTable();
};

function showBatchMsg(tab,msg){
  const el=document.getElementById('batch-'+tab+'-msg');
  if(!el) return;
  el.textContent=msg;el.style.display='';
  setTimeout(()=>el.style.display='none',3500);
}

window.downloadCSVTemplate=()=>{
  const header='æ´»å‹•åç¨±,é–‹å§‹æ—¥æœŸ,çµæŸæ—¥æœŸ,é–‹å§‹æ™‚é–“,çµæŸæ™‚é–“,åœ°é»,è™•å®¤,å‚™è¨»';
  const sample=['æœŸä¸­è€ƒ,2026-04-15,2026-04-17,08:00,16:00,4Fåœ–æ›¸é¤¨,æ•™å‹™è™•,è«‹å„ç­é…åˆ','é‹å‹•æœƒ,2026-05-10,2026-05-10,08:30,17:00,çƒå ´å—ä¸€ï¼ˆäºŒ.äº”.å…­å¹´ç´šï¼‰,å­¸å‹™è™•,','ç•¢æ¥­å…¸ç¦®,2026-06-12,2026-06-12,09:00,12:00,5Fæ´»å‹•ä¸­å¿ƒ,æ•™å‹™è™•,'].join('\n');
  const blob=new Blob(['\uFEFF'+header+'\n'+sample],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='è¡Œäº‹æ›†ç¯„æœ¬.csv';a.click();
};

window.handleCSVDrop=(e)=>{e.preventDefault();document.getElementById('csv-drop-zone').style.borderColor='var(--border)';const f=e.dataTransfer.files[0];if(f) processCSVFile(f);};
window.handleCSVFile=(input)=>{if(input.files[0]) processCSVFile(input.files[0]);};

function processCSVFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    let text=e.target.result;
    if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
    const lines=text.split(/\r?\n/).filter(l=>l.trim());
    if(lines.length<2){alert('CSV å…§å®¹ä¸è¶³');return;}
    csvRows=lines.slice(1).map(line=>{
      const cols=parseCSVLine(line);
      return{title:cols[0]||'',start:cols[1]||'',end:cols[2]||cols[1]||'',stime:cols[3]||'',etime:cols[4]||'',location:cols[5]||'',dept:cols[6]||'æ•™å‹™è™•',note:cols[7]||''};
    }).filter(r=>r.title&&r.start);
    renderCSVPreview();
  };
  reader.readAsText(file,'UTF-8');
}

function parseCSVLine(line){
  const result=[];let cur='';let inQ=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"'){inQ=!inQ;}
    else if(c===','&&!inQ){result.push(cur.trim());cur='';}
    else{cur+=c;}
  }
  result.push(cur.trim());return result;
}

function renderCSVPreview(){
  if(!csvRows.length){alert('æ²’æœ‰å¯åŒ¯å…¥çš„è³‡æ–™');return;}
  document.getElementById('csv-preview-label').textContent=`é è¦½ ${csvRows.length} ç­†è³‡æ–™ï¼ˆå‰10ç­†ï¼‰ï¼š`;
  const thead=document.getElementById('csv-preview-thead');
  const tbody=document.getElementById('csv-preview-tbody');
  thead.innerHTML='<tr>'+['æ´»å‹•åç¨±','é–‹å§‹æ—¥æœŸ','çµæŸæ—¥æœŸ','åœ°é»','è™•å®¤','å‚™è¨»'].map(h=>`<th style="padding:0.4rem 0.6rem;text-align:left;border-bottom:1px solid var(--border);font-size:0.76rem;font-weight:600;color:var(--text2);">${h}</th>`).join('')+'</tr>';
  tbody.innerHTML=csvRows.slice(0,10).map(r=>`<tr style="border-bottom:1px solid var(--border);">${[r.title,r.start,r.end,r.location,r.dept,r.note].map(v=>`<td style="padding:0.38rem 0.6rem;font-size:0.76rem;">${v||'â€”'}</td>`).join('')}</tr>`).join('');
  document.getElementById('csv-preview').style.display='';
}

window.importCSV=async()=>{
  if(!csvRows.length) return;
  const btn=document.getElementById('btn-import-csv');
  const msg=document.getElementById('csv-import-msg');
  btn.disabled=true;btn.textContent='åŒ¯å…¥ä¸­â€¦';
  msg.textContent='';msg.style.display='';
  let ok=0,fail=0;
  for(const row of csvRows){
    try{await addDoc(collection(db,COL),{...row,end:row.end||row.start,createdBy:currentUser.email,createdAt:serverTimestamp(),updatedAt:serverTimestamp()});ok++;}
    catch(e){fail++;}
  }
  btn.disabled=false;btn.textContent='âœ… ç¢ºèªåŒ¯å…¥';
  msg.textContent=`âœ… æˆåŠŸåŒ¯å…¥ ${ok} ç­†${fail?`ï¼Œ${fail} ç­†å¤±æ•—`:''}`;
  csvRows=[];
  document.getElementById('csv-preview').style.display='none';
  document.getElementById('csv-file-input').value='';
};

window.parsePasteText=()=>{
  const text=document.getElementById('paste-text').value.trim();
  const dept=document.getElementById('paste-dept').value;
  const loc=document.getElementById('paste-loc').value;
  const msg=document.getElementById('paste-msg');
  if(!text){msg.textContent='è«‹å…ˆè¼¸å…¥æ–‡å­—';msg.style.display='';return;}
  const curYr=new Date().getFullYear();
  const lines=text.split(/\n/).map(l=>l.trim()).filter(Boolean);
  parsedRows=[];
  lines.forEach(line=>{
    const parts=line.split('ã€');
    parts.forEach((part,pi)=>{
      part=part.trim();
      const rangeMatch=part.match(/^(\d{1,2})\/(\d{1,2})[~\-ï½](\d{1,2})\/(\d{1,2})\s*(.*)$/);
      if(rangeMatch){
        let title=rangeMatch[5].trim()||parts[parts.length-1].replace(/^\d+\/\d+[~\-ï½\d\/]*/,'').trim()||'ï¼ˆå¾…å¡«ï¼‰';
        parsedRows.push({title,start:`${curYr}-${pad(rangeMatch[1])}-${pad(rangeMatch[2])}`,end:`${curYr}-${pad(rangeMatch[3])}-${pad(rangeMatch[4])}`,dept,location:loc,stime:'',etime:'',note:''});
        return;
      }
      const singleMatch=part.match(/^(\d{1,2})\/(\d{1,2})\s*(.*)$/);
      if(singleMatch){
        let title=singleMatch[3].trim();
        if(!title&&pi<parts.length-1) title=parts[parts.length-1].replace(/^\d+\/\d+\s*/,'').trim();
        if(!title) title='ï¼ˆå¾…å¡«ï¼‰';
        parsedRows.push({title,start:`${curYr}-${pad(singleMatch[1])}-${pad(singleMatch[2])}`,end:`${curYr}-${pad(singleMatch[1])}-${pad(singleMatch[2])}`,dept,location:loc,stime:'',etime:'',note:''});
      }
    });
  });
  if(!parsedRows.length){msg.textContent='ç„¡æ³•è§£æï¼Œè«‹ç¢ºèªæ ¼å¼';msg.style.display='';return;}
  msg.textContent=`è§£æåˆ° ${parsedRows.length} ç­†æ´»å‹•`;msg.style.display='';
  renderPastePreview();
};

function renderPastePreview(){
  const tbody=document.getElementById('paste-preview-tbody');
  tbody.innerHTML='';
  parsedRows.forEach((row,i)=>{
    const deptOpts=DEPTS.map(d=>`<option value="${d}" ${row.dept===d?'selected':''}>${d}</option>`).join('');
    const locOpts=BATCH_LOCS.map(l=>`<option value="${l}" ${row.location===l?'selected':''}>${l||'ï¼ˆæœªå¡«ï¼‰'}</option>`).join('');
    const tr=document.createElement('tr');
    tr.style.borderBottom='1px solid var(--border)';
    tr.innerHTML=`
      <td style="padding:0.32rem 0.48rem;"><input style="width:100%;padding:0.24rem 0.38rem;border:1.5px solid var(--border);border-radius:5px;font-size:0.78rem;font-family:'Noto Sans TC',sans-serif;" value="${esc(row.title)}" onchange="parsedRows[${i}].title=this.value"></td>
      <td style="padding:0.32rem 0.48rem;"><input type="date" style="padding:0.24rem 0.38rem;border:1.5px solid var(--border);border-radius:5px;font-size:0.76rem;" value="${row.start}" onchange="parsedRows[${i}].start=this.value"></td>
      <td style="padding:0.32rem 0.48rem;"><input type="date" style="padding:0.24rem 0.38rem;border:1.5px solid var(--border);border-radius:5px;font-size:0.76rem;" value="${row.end}" onchange="parsedRows[${i}].end=this.value"></td>
      <td style="padding:0.32rem 0.48rem;"><select style="padding:0.24rem 0.32rem;border:1.5px solid var(--border);border-radius:5px;font-size:0.76rem;font-family:'Noto Sans TC',sans-serif;" onchange="parsedRows[${i}].dept=this.value">${deptOpts}</select></td>
      <td style="padding:0.32rem 0.48rem;"><select style="padding:0.24rem 0.32rem;border:1.5px solid var(--border);border-radius:5px;font-size:0.76rem;font-family:'Noto Sans TC',sans-serif;" onchange="parsedRows[${i}].location=this.value">${locOpts}</select></td>
      <td style="padding:0.32rem 0.48rem;text-align:center;"><button onclick="parsedRows.splice(${i},1);renderPastePreview()" style="background:#fee2e2;color:#dc2626;border:none;border-radius:4px;padding:0.18rem 0.42rem;cursor:pointer;font-size:0.7rem;">âœ•</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('paste-preview').style.display='';
}

window.importParsed=async()=>{
  if(!parsedRows.length) return;
  const btn=document.getElementById('btn-import-parsed');
  const msg=document.getElementById('import-msg');
  btn.disabled=true;btn.textContent='åŒ¯å…¥ä¸­â€¦';
  msg.textContent='';msg.style.display='';
  let ok=0,fail=0;
  for(const row of parsedRows){
    if(!row.title||!row.start){fail++;continue;}
    try{await addDoc(collection(db,COL),{...row,end:row.end||row.start,createdBy:currentUser.email,createdAt:serverTimestamp(),updatedAt:serverTimestamp()});ok++;}
    catch(e){fail++;}
  }
  btn.disabled=false;btn.textContent='âœ… ç¢ºèªåŒ¯å…¥';
  msg.textContent=`âœ… åŒ¯å…¥ ${ok} ç­†æˆåŠŸ${fail?`ï¼Œ${fail} ç­†å¤±æ•—`:''}`;
  parsedRows=[];
  document.getElementById('paste-preview').style.display='none';
  document.getElementById('paste-text').value='';
  document.getElementById('paste-msg').style.display='none';
};

// Close on overlay click
document.querySelectorAll('.modal-overlay').forEach(o=>{
  o.addEventListener('click',e=>{if(e.target===o) o.classList.remove('open');});
});
</script>
</body>
</html>
