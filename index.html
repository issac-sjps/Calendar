<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°èŠåœ‹å° å­¸æ ¡è¡Œäº‹æ›†</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@700;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f0f4f8;
      --surface: #ffffff;
      --surface2: #f8fafc;
      --border: #e2e8f0;
      --text: #1a202c;
      --text2: #4a5568;
      --text3: #a0aec0;
      --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.06);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.14);
      --æ•™å‹™è™•: #3b82f6; --æ•™å‹™è™•-light: #eff6ff; --æ•™å‹™è™•-text: #1d4ed8;
      --å­¸å‹™è™•: #10b981; --å­¸å‹™è™•-light: #f0fdf4; --å­¸å‹™è™•-text: #065f46;
      --è¼”å°è™•: #f59e0b; --è¼”å°è™•-light: #fffbeb; --è¼”å°è™•-text: #92400e;
      --ç¸½å‹™è™•: #8b5cf6; --ç¸½å‹™è™•-light: #f5f3ff; --ç¸½å‹™è™•-text: #5b21b6;
      --green: #2d7a4f;
    }
    body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* Header */
    header {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 0 1.5rem; display: flex; align-items: center;
      justify-content: space-between; height: 60px;
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 1px 8px rgba(0,0,0,0.06);
    }
    .header-left { display: flex; align-items: center; gap: 0.75rem; }
    .school-badge {
      background: #1a202c; color: #fff;
      font-family: 'Noto Serif TC', serif; font-weight: 900;
      font-size: 0.85rem; padding: 0.3rem 0.6rem; letter-spacing: 0.05em;
    }
    .school-title { font-family: 'Noto Serif TC', serif; font-weight: 700; font-size: 1rem; color: var(--text); }
    .header-right { display: flex; align-items: center; gap: 0.75rem; }
    #user-info { font-size: 0.8rem; color: var(--text2); display: none; align-items: center; gap: 0.5rem; }
    .user-dept { padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.72rem; font-weight: 500; }
    .btn-sm { padding: 0.4rem 1rem; border-radius: 6px; font-family: 'Noto Sans TC', sans-serif; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-primary { background: #1a202c; color: #fff; }
    .btn-primary:hover { background: #2d3748; }
    .btn-outline { background: none; border: 1px solid var(--border) !important; color: var(--text2); }
    .btn-outline:hover { border-color: #a0aec0 !important; color: var(--text); }

    /* Legend */
    .legend-bar {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 0.6rem 1.5rem; display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;
    }
    .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.78rem; color: var(--text2); cursor: pointer; transition: opacity 0.15s; user-select: none; }
    .legend-item.dimmed { opacity: 0.35; }
    .legend-dot { width: 10px; height: 10px; border-radius: 2px; }

    /* Main */
    .main { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }

    /* Cal Nav */
    .cal-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
    .cal-nav-center { display: flex; align-items: center; gap: 1rem; }
    .cal-month { font-family: 'Noto Serif TC', serif; font-size: 1.4rem; font-weight: 700; min-width: 160px; text-align: center; }
    .icon-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: all 0.15s; color: var(--text2); }
    .icon-btn:hover { background: var(--bg); border-color: #a0aec0; color: var(--text); }
    .today-btn { padding: 0.4rem 0.9rem; border-radius: 6px; border: 1px solid var(--border); background: var(--surface); font-family: 'Noto Sans TC', sans-serif; font-size: 0.8rem; cursor: pointer; color: var(--text2); transition: all 0.15s; }
    .today-btn:hover { background: var(--bg); color: var(--text); }

    /* Calendar Grid */
    .cal-grid { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; }
    .cal-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); border-bottom: 1px solid var(--border); background: var(--surface2); }
    .cal-weekday { padding: 0.6rem; text-align: center; font-size: 0.75rem; font-weight: 500; color: var(--text3); letter-spacing: 0.05em; }
    .cal-weekday:first-child { color: #e53e3e; }
    .cal-weekday:last-child { color: #3182ce; }
    .cal-days { display: grid; grid-template-columns: repeat(7, 1fr); }

    .cal-day {
      min-height: 115px; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border);
      padding: 0.35rem 0.35rem 0.35rem 0.35rem; position: relative; transition: background 0.12s;
    }
    .cal-day:nth-child(7n) { border-right: none; }
    .cal-day:nth-last-child(-n+7) { border-bottom: none; }
    .cal-day.other-month { background: var(--surface2); }
    .cal-day.other-month .day-num { color: var(--text3); }
    .cal-day.today .day-num { background: #1a202c; color: #fff; border-radius: 50%; }
    .cal-day.sunday .day-num { color: #e53e3e; }
    .cal-day.saturday .day-num { color: #3182ce; }

    /* Clickable day hint when logged in */
    .cal-day.clickable:not(.other-month):hover {
      background: #f0f7ff;
      cursor: pointer;
    }
    .cal-day.clickable:not(.other-month):hover .day-num {
      background: #e2eeff;
      border-radius: 50%;
    }
    .cal-day.clickable.today:hover .day-num {
      background: #2d3748;
    }

    /* Plus hint on hover */
    .cal-day.clickable:not(.other-month)::after {
      content: 'ï¼‹';
      position: absolute;
      top: 4px; right: 6px;
      font-size: 0.75rem;
      color: var(--text3);
      opacity: 0;
      transition: opacity 0.15s;
      pointer-events: none;
    }
    .cal-day.clickable:not(.other-month):hover::after { opacity: 1; }

    .day-num { font-size: 0.82rem; font-weight: 500; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; margin-bottom: 0.2rem; border-radius: 50%; transition: background 0.12s; }
    .day-events { display: flex; flex-direction: column; gap: 2px; }
    .event-chip { border-radius: 4px; padding: 1px 5px; font-size: 0.67rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; transition: filter 0.1s; line-height: 1.5; }
    .event-chip:hover { filter: brightness(0.9); }
    .more-events { font-size: 0.65rem; color: var(--text3); padding: 1px 4px; cursor: pointer; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 200; padding: 1rem; backdrop-filter: blur(3px); }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--surface); border-radius: 16px; box-shadow: var(--shadow-lg); width: 100%; max-width: 480px; animation: modalIn 0.22s cubic-bezier(0.16,1,0.3,1); overflow: hidden; }
    @keyframes modalIn { from { opacity:0; transform:scale(0.94) translateY(10px); } to { opacity:1; transform:scale(1) translateY(0); } }
    .modal-header { padding: 1.25rem 1.5rem 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal-header h3 { font-size: 1rem; font-weight: 700; }
    .modal-close { width: 28px; height: 28px; border-radius: 6px; border: none; background: var(--bg); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; color: var(--text2); transition: background 0.1s; }
    .modal-close:hover { background: var(--border); }
    .modal-body { padding: 1.25rem 1.5rem; max-height: 70vh; overflow-y: auto; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-size: 0.78rem; font-weight: 500; color: var(--text2); margin-bottom: 0.35rem; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 0.55rem 0.75rem; border: 1.5px solid var(--border);
      border-radius: 8px; font-family: 'Noto Sans TC', sans-serif; font-size: 0.88rem;
      color: var(--text); background: var(--surface); outline: none; transition: border-color 0.15s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #1a202c; }
    .form-group textarea { resize: vertical; min-height: 64px; }
    .required { color: #e53e3e; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem; }
    .btn-md { padding: 0.55rem 1.25rem; border-radius: 8px; font-family: 'Noto Sans TC', sans-serif; font-size: 0.85rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-md.btn-primary { background: #1a202c; color: #fff; }
    .btn-md.btn-primary:hover { background: #2d3748; }
    .btn-md.btn-cancel { background: var(--bg); color: var(--text2); }
    .btn-md.btn-cancel:hover { background: var(--border); }
    .btn-md.btn-delete { background: #fee2e2; color: #dc2626; }
    .btn-md.btn-delete:hover { background: #fecaca; }
    .btn-md:disabled { opacity: 0.5; cursor: not-allowed; }
    .form-msg { font-size: 0.78rem; color: #e53e3e; margin-top: 0.5rem; display: none; }
    .form-msg.success { color: var(--green); }

    /* Day Detail Modal */
    .day-detail-modal .modal { max-width: 520px; }
    .day-detail-date {
      font-family: 'Noto Serif TC', serif;
      font-size: 1.1rem; font-weight: 700;
      padding: 1.25rem 1.5rem 0.75rem;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .dept-section { margin-bottom: 1rem; }
    .dept-section-header {
      display: flex; align-items: center; gap: 0.5rem;
      font-size: 0.8rem; font-weight: 700;
      padding: 0.4rem 0.6rem; border-radius: 6px;
      margin-bottom: 0.5rem;
    }
    .dept-dot { width: 8px; height: 8px; border-radius: 2px; }
    .event-card {
      border: 1px solid var(--border); border-radius: 10px;
      padding: 0.75rem 1rem; margin-bottom: 0.5rem;
      transition: box-shadow 0.15s; background: var(--surface);
      cursor: default;
    }
    .event-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .event-card-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.35rem; }
    .event-card-meta { font-size: 0.75rem; color: var(--text2); display: flex; flex-wrap: wrap; gap: 0.75rem; }
    .event-card-meta span { display: flex; align-items: center; gap: 0.3rem; }
    .event-card-actions { display: flex; gap: 0.4rem; margin-top: 0.6rem; }
    .btn-xs { padding: 0.25rem 0.65rem; border-radius: 5px; font-size: 0.72rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.12s; font-family: 'Noto Sans TC', sans-serif; }
    .btn-xs.edit { background: var(--bg); color: var(--text2); }
    .btn-xs.edit:hover { background: var(--border); color: var(--text); }
    .btn-xs.del { background: #fee2e2; color: #dc2626; }
    .btn-xs.del:hover { background: #fecaca; }
    .no-events { font-size: 0.82rem; color: var(--text3); text-align: center; padding: 1.5rem 0; }
    .add-from-day { width: 100%; margin-top: 0.5rem; padding: 0.6rem; border-radius: 8px; border: 1.5px dashed var(--border); background: none; font-family: 'Noto Sans TC', sans-serif; font-size: 0.82rem; color: var(--text3); cursor: pointer; transition: all 0.15s; display: none; }
    .add-from-day:hover { border-color: #a0aec0; color: var(--text2); background: var(--surface2); }

    /* Login Modal */
    .login-modal .modal { max-width: 380px; }

    /* Loading */
    .loading-overlay { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 300; flex-direction: column; gap: 1rem; }
    .loading-text { font-size: 0.85rem; color: var(--text3); }
    .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--text); border-radius: 50%; animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Dept color utils */
    .bg-æ•™å‹™è™• { background: var(--æ•™å‹™è™•); color: #fff; }
    .bg-å­¸å‹™è™• { background: var(--å­¸å‹™è™•); color: #fff; }
    .bg-è¼”å°è™• { background: var(--è¼”å°è™•); color: #fff; }
    .bg-ç¸½å‹™è™• { background: var(--ç¸½å‹™è™•); color: #fff; }
    .soft-æ•™å‹™è™• { background: var(--æ•™å‹™è™•-light); color: var(--æ•™å‹™è™•-text); }
    .soft-å­¸å‹™è™• { background: var(--å­¸å‹™è™•-light); color: var(--å­¸å‹™è™•-text); }
    .soft-è¼”å°è™• { background: var(--è¼”å°è™•-light); color: var(--è¼”å°è™•-text); }
    .soft-ç¸½å‹™è™• { background: var(--ç¸½å‹™è™•-light); color: var(--ç¸½å‹™è™•-text); }
    .dot-æ•™å‹™è™• { background: var(--æ•™å‹™è™•); }
    .dot-å­¸å‹™è™• { background: var(--å­¸å‹™è™•); }
    .dot-è¼”å°è™• { background: var(--è¼”å°è™•); }
    .dot-ç¸½å‹™è™• { background: var(--ç¸½å‹™è™•); }

    @media (max-width: 640px) {
      .cal-day { min-height: 72px; padding: 0.25rem; }
      .school-title { display: none; }
      .legend-bar { gap: 0.75rem; }
      .main { padding: 1rem; }
      .cal-month { font-size: 1.1rem; min-width: 120px; }
      .form-row { grid-template-columns: 1fr; }
      header { padding: 0 1rem; }
    }
  </style>
</head>
<body>

<!-- Loading -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text">è¼‰å…¥ä¸­...</div>
</div>

<!-- Header -->
<header>
  <div class="header-left">
    <div class="school-badge">æ–°èŠåœ‹å°</div>
    <span class="school-title">å­¸æ ¡è¡Œäº‹æ›†</span>
  </div>
  <div class="header-right">
    <div id="user-info">
      <span id="user-dept-badge" class="user-dept"></span>
      <span id="user-email-text" style="font-size:0.75rem;color:var(--text3);"></span>
    </div>
    <button class="btn-sm btn-outline" id="btn-logout" style="display:none" onclick="handleLogout()">ç™»å‡º</button>
    <button class="btn-sm btn-primary" id="btn-login-open" onclick="openLoginModal()">æ•™è·å“¡ç™»å…¥</button>
  </div>
</header>

<!-- Legend -->
<div class="legend-bar">
  <span style="font-size:0.75rem;color:var(--text3);">é¡¯ç¤ºï¼š</span>
  <div class="legend-item" onclick="toggleDept('æ•™å‹™è™•')" id="legend-æ•™å‹™è™•">
    <div class="legend-dot dot-æ•™å‹™è™•"></div><span>æ•™å‹™è™•</span>
  </div>
  <div class="legend-item" onclick="toggleDept('å­¸å‹™è™•')" id="legend-å­¸å‹™è™•">
    <div class="legend-dot dot-å­¸å‹™è™•"></div><span>å­¸å‹™è™•</span>
  </div>
  <div class="legend-item" onclick="toggleDept('è¼”å°è™•')" id="legend-è¼”å°è™•">
    <div class="legend-dot dot-è¼”å°è™•"></div><span>è¼”å°è™•</span>
  </div>
  <div class="legend-item" onclick="toggleDept('ç¸½å‹™è™•')" id="legend-ç¸½å‹™è™•">
    <div class="legend-dot dot-ç¸½å‹™è™•"></div><span>ç¸½å‹™è™•</span>
  </div>
  <div style="margin-left:auto">
    <button class="btn-sm btn-primary" id="btn-add-event" style="display:none" onclick="openAddModal(null)">ï¼‹ æ–°å¢æ´»å‹•</button>
  </div>
</div>

<!-- Calendar -->
<div class="main">
  <div class="cal-nav">
    <div class="cal-nav-center">
      <button class="icon-btn" onclick="changeMonth(-1)">â€¹</button>
      <div class="cal-month" id="cal-month-label"></div>
      <button class="icon-btn" onclick="changeMonth(1)">â€º</button>
    </div>
    <button class="today-btn" onclick="goToday()">ä»Šå¤©</button>
  </div>
  <div class="cal-grid">
    <div class="cal-weekdays">
      <div class="cal-weekday">æ—¥</div><div class="cal-weekday">ä¸€</div>
      <div class="cal-weekday">äºŒ</div><div class="cal-weekday">ä¸‰</div>
      <div class="cal-weekday">å››</div><div class="cal-weekday">äº”</div>
      <div class="cal-weekday">å…­</div>
    </div>
    <div class="cal-days" id="cal-days"></div>
  </div>
</div>

<!-- â”€â”€ Day Detail Modal â”€â”€ -->
<div class="modal-overlay day-detail-modal" id="modal-day">
  <div class="modal" style="max-width:520px">
    <div class="day-detail-date">
      <span id="day-detail-title"></span>
      <button class="modal-close" onclick="closeDayModal()">âœ•</button>
    </div>
    <div class="modal-body" id="day-detail-body" style="padding:1.25rem 1.5rem;"></div>
    <div class="modal-footer" style="border-top:1px solid var(--border)">
      <button class="add-from-day" id="add-from-day-btn" onclick="addFromDayModal()">ï¼‹ æ–°å¢é€™å¤©çš„æ´»å‹•</button>
      <div style="flex:1"></div>
      <button class="btn-md btn-cancel" onclick="closeDayModal()">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Add / Edit Event Modal â”€â”€ -->
<div class="modal-overlay" id="modal-add">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-add-title">æ–°å¢æ´»å‹•</h3>
      <button class="modal-close" onclick="closeAddModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>æ´»å‹•åç¨± <span class="required">*</span></label>
        <input type="text" id="ev-title" placeholder="ä¾‹ï¼šæœŸä¸­è€ƒã€é‹å‹•æœƒâ€¦">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>é–‹å§‹æ—¥æœŸ <span class="required">*</span></label>
          <input type="date" id="ev-start">
        </div>
        <div class="form-group">
          <label>çµæŸæ—¥æœŸ <span class="required">*</span></label>
          <input type="date" id="ev-end">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>é–‹å§‹æ™‚é–“</label>
          <input type="time" id="ev-start-time">
        </div>
        <div class="form-group">
          <label>çµæŸæ™‚é–“</label>
          <input type="time" id="ev-end-time">
        </div>
      </div>
      <div class="form-group">
        <label>åœ°é» / æ•™å®¤ <span class="required">*</span></label>
        <input type="text" id="ev-location" placeholder="ä¾‹ï¼šæ´»å‹•ä¸­å¿ƒã€é›»è…¦æ•™å®¤â€¦">
      </div>
      <div class="form-group">
        <label>æ‰€å±¬è™•å®¤ <span class="required">*</span></label>
        <select id="ev-dept">
          <option value="æ•™å‹™è™•">æ•™å‹™è™•</option>
          <option value="å­¸å‹™è™•">å­¸å‹™è™•</option>
          <option value="è¼”å°è™•">è¼”å°è™•</option>
          <option value="ç¸½å‹™è™•">ç¸½å‹™è™•</option>
        </select>
      </div>
      <div class="form-group">
        <label>å‚™è¨»èªªæ˜</label>
        <textarea id="ev-note" placeholder="é¸å¡«â€¦"></textarea>
      </div>
      <div class="form-msg" id="add-msg"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-md btn-delete" id="btn-delete-ev" style="display:none" onclick="handleDeleteEvent()">åˆªé™¤</button>
      <div style="flex:1"></div>
      <button class="btn-md btn-cancel" onclick="closeAddModal()">å–æ¶ˆ</button>
      <button class="btn-md btn-primary" id="btn-save-ev" onclick="handleSaveEvent()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Login Modal â”€â”€ -->
<div class="modal-overlay login-modal" id="modal-login">
  <div class="modal" style="max-width:380px">
    <div class="modal-header">
      <h3>æ•™è·å“¡ç™»å…¥</h3>
      <button class="modal-close" onclick="closeLoginModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <p style="font-size:0.8rem;color:var(--text3);margin-bottom:1rem;line-height:1.7;">
        åƒ…é™ <strong style="color:var(--text)">@sjps.kh.edu.tw</strong> ä¿¡ç®±ç™»å…¥<br>
        è¨ªå®¢å¯ç›´æ¥ç€è¦½è¡Œäº‹æ›†ï¼Œç„¡éœ€ç™»å…¥
      </p>
      <div class="form-group">
        <label>å­¸æ ¡é›»å­éƒµä»¶</label>
        <input type="email" id="login-email" placeholder="yourname@sjps.kh.edu.tw">
      </div>
      <div class="form-group">
        <label>å¯†ç¢¼</label>
        <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <div class="form-msg" id="login-msg"></div>
    </div>
    <div class="modal-footer" style="flex-direction:column;align-items:stretch;gap:0.5rem;">
      <button class="btn-md btn-primary" onclick="handleEmailLogin()" style="width:100%;padding:0.65rem;justify-content:center;">ç™»å…¥</button>
      <button class="btn-md" onclick="handleGoogleLogin()" style="width:100%;padding:0.65rem;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;gap:0.5rem;">
        <svg width="16" height="16" viewBox="0 0 48 48">
          <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
          <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
          <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
          <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
        </svg>
        ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
      </button>
      <div style="text-align:center;font-size:0.72rem;color:var(--text3);margin-top:0.25rem;">
        <a onclick="handleForgotPassword()" style="color:var(--text3);cursor:pointer;text-decoration:underline;">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getAuth, signInWithEmailAndPassword, signInWithPopup,
  GoogleAuthProvider, sendPasswordResetEmail, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, updateDoc, deleteDoc,
  doc, query, orderBy, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAhAduO-twiIX8kPUcXcwJDyuRCZT_GOZI",
  authDomain: "myproject-c52cb.firebaseapp.com",
  projectId: "myproject-c52cb",
  storageBucket: "myproject-c52cb.firebasestorage.app",
  messagingSenderId: "494432013878",
  appId: "1:494432013878:web:3c631ca98030600f915297",
  measurementId: "G-T8CQ3288ZM"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const gProvider = new GoogleAuthProvider();
const DOMAIN = 'sjps.kh.edu.tw';
const COL = 'calendar_events';
const DEPTS = ['æ•™å‹™è™•','å­¸å‹™è™•','è¼”å°è™•','ç¸½å‹™è™•'];

let currentUser = null;
let curYear = new Date().getFullYear();
let curMonth = new Date().getMonth();
let events = [];
let hiddenDepts = new Set();
let editingId = null;
let dayModalDate = null; // currently open day modal date string

// â”€â”€ Auth â”€â”€
onAuthStateChanged(auth, user => {
  if (user) {
    const domain = (user.email||'').split('@')[1];
    if (domain !== DOMAIN) { signOut(auth); showMsg('login-msg','error',`åƒ…é™ @${DOMAIN} ä¿¡ç®±`); return; }
    currentUser = user;
    document.getElementById('user-info').style.display = 'flex';
    document.getElementById('user-email-text').textContent = user.email.split('@')[0];
    document.getElementById('btn-logout').style.display = '';
    document.getElementById('btn-login-open').style.display = 'none';
    document.getElementById('btn-add-event').style.display = '';
    closeLoginModal();
  } else {
    currentUser = null;
    document.getElementById('user-info').style.display = 'none';
    document.getElementById('btn-logout').style.display = 'none';
    document.getElementById('btn-login-open').style.display = '';
    document.getElementById('btn-add-event').style.display = 'none';
  }
  document.getElementById('loading').style.display = 'none';
  renderCalendar();
});

// â”€â”€ Firestore realtime â”€â”€
onSnapshot(query(collection(db, COL), orderBy('start')), snap => {
  events = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderCalendar();
  if (dayModalDate) renderDayModal(dayModalDate); // refresh open day modal
}, err => {
  console.error(err);
  document.getElementById('loading').style.display = 'none';
});

// â”€â”€ Helpers â”€â”€
function pad(n){ return String(n).padStart(2,'0'); }
function toDateStr(y, m, d){
  let adjY = y, adjM = m;
  if(m < 0){ adjY--; adjM = 11; } else if(m > 11){ adjY++; adjM = 0; }
  // handle further overflow if needed
  const dt = new Date(y, m, d);
  return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
}
function formatDateLabel(str){
  const [y,m,d] = str.split('-');
  const dow = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(str).getDay()];
  return `${y} å¹´ ${parseInt(m)} æœˆ ${parseInt(d)} æ—¥ï¼ˆ${dow}ï¼‰`;
}
function eventsOnDate(dateStr){
  return events.filter(e => {
    const end = e.end || e.start;
    return dateStr >= e.start && dateStr <= end;
  });
}
function showMsg(id, type, text){
  const el = document.getElementById(id);
  el.textContent = text;
  el.className = `form-msg ${type === 'success' ? 'success' : ''}`;
  el.style.display = 'block';
}
function clearMsg(id){ const el = document.getElementById(id); el.style.display='none'; el.textContent=''; }

// â”€â”€ Calendar Render â”€â”€
function renderCalendar(){
  document.getElementById('cal-month-label').textContent = `${curYear} å¹´ ${curMonth+1} æœˆ`;
  const firstDow = new Date(curYear, curMonth, 1).getDay();
  const daysInMonth = new Date(curYear, curMonth+1, 0).getDate();
  const today = new Date();
  const container = document.getElementById('cal-days');
  container.innerHTML = '';

  const prevTotal = new Date(curYear, curMonth, 0).getDate();
  for(let i = firstDow-1; i >= 0; i--){
    container.appendChild(makeCell(new Date(curYear, curMonth-1, prevTotal-i), true));
  }
  for(let d = 1; d <= daysInMonth; d++){
    const isToday = today.getFullYear()===curYear && today.getMonth()===curMonth && today.getDate()===d;
    container.appendChild(makeCell(new Date(curYear, curMonth, d), false, isToday));
  }
  const total = firstDow + daysInMonth;
  const rem = total % 7 === 0 ? 0 : 7 - (total % 7);
  for(let d = 1; d <= rem; d++){
    container.appendChild(makeCell(new Date(curYear, curMonth+1, d), true));
  }
}

function makeCell(date, otherMonth, isToday=false){
  const dateStr = `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`;
  const dow = date.getDay();

  const cell = document.createElement('div');
  cell.className = 'cal-day' +
    (otherMonth ? ' other-month' : '') +
    (isToday ? ' today' : '') +
    (!otherMonth && dow===0 ? ' sunday' : '') +
    (!otherMonth && dow===6 ? ' saturday' : '') +
    (!otherMonth && currentUser ? ' clickable' : '');

  // Day number â€” click to open day detail
  const numEl = document.createElement('div');
  numEl.className = 'day-num';
  numEl.textContent = date.getDate();
  numEl.onclick = (e) => {
    e.stopPropagation();
    openDayModal(dateStr);
  };
  cell.appendChild(numEl);

  // Events
  const dayEvs = events.filter(e => {
    if(hiddenDepts.has(e.dept)) return false;
    const end = e.end || e.start;
    return dateStr >= e.start && dateStr <= end;
  });

  const evEl = document.createElement('div');
  evEl.className = 'day-events';
  const MAX = 3;
  dayEvs.slice(0, MAX).forEach(ev => {
    const chip = document.createElement('div');
    chip.className = `event-chip bg-${ev.dept}`;
    chip.textContent = ev.title;
    chip.title = ev.title;
    chip.onclick = (e) => { e.stopPropagation(); openDayModal(dateStr); };
    evEl.appendChild(chip);
  });
  if(dayEvs.length > MAX){
    const more = document.createElement('div');
    more.className = 'more-events';
    more.textContent = `é‚„æœ‰ ${dayEvs.length - MAX} å€‹`;
    more.onclick = (e) => { e.stopPropagation(); openDayModal(dateStr); };
    evEl.appendChild(more);
  }
  cell.appendChild(evEl);

  // Click on cell background â†’ add event (only logged in, non-other-month)
  if(!otherMonth && currentUser){
    cell.onclick = () => openAddModal(dateStr);
  }

  return cell;
}

window.changeMonth = (d) => {
  curMonth += d;
  if(curMonth < 0){ curMonth=11; curYear--; }
  if(curMonth > 11){ curMonth=0; curYear++; }
  renderCalendar();
};
window.goToday = () => { curYear=new Date().getFullYear(); curMonth=new Date().getMonth(); renderCalendar(); };
window.toggleDept = (dept) => {
  hiddenDepts.has(dept) ? hiddenDepts.delete(dept) : hiddenDepts.add(dept);
  document.getElementById(`legend-${dept}`).classList.toggle('dimmed', hiddenDepts.has(dept));
  renderCalendar();
};

// â”€â”€ Day Modal â”€â”€
window.openDayModal = (dateStr) => {
  dayModalDate = dateStr;
  document.getElementById('day-detail-title').textContent = formatDateLabel(dateStr);
  renderDayModal(dateStr);
  // Show "add" button only if logged in
  const addBtn = document.getElementById('add-from-day-btn');
  addBtn.style.display = currentUser ? 'block' : 'none';
  document.getElementById('modal-day').classList.add('open');
};

function renderDayModal(dateStr){
  const body = document.getElementById('day-detail-body');
  body.innerHTML = '';
  const dayEvs = eventsOnDate(dateStr);

  let hasAny = false;
  DEPTS.forEach(dept => {
    const dEvs = dayEvs.filter(e => e.dept === dept);
    if(dEvs.length === 0) return;
    hasAny = true;

    const section = document.createElement('div');
    section.className = 'dept-section';

    const hdr = document.createElement('div');
    hdr.className = `dept-section-header soft-${dept}`;
    hdr.innerHTML = `<div class="dept-dot dot-${dept}"></div><span>${dept}</span>`;
    section.appendChild(hdr);

    dEvs.forEach(ev => {
      const card = document.createElement('div');
      card.className = 'event-card';

      let timeLine = '';
      if(ev.startTime || ev.endTime){
        timeLine = `<span>ğŸ• ${ev.startTime||''}${ev.endTime ? ' â€“ '+ev.endTime : ''}</span>`;
      }
      const locLine = ev.location ? `<span>ğŸ“ ${ev.location}</span>` : '';
      const dateLine = ev.end && ev.end !== ev.start
        ? `<span>ğŸ“… ${ev.start} ï½ ${ev.end}</span>`
        : `<span>ğŸ“… ${ev.start}</span>`;

      card.innerHTML = `
        <div class="event-card-title">${ev.title}</div>
        <div class="event-card-meta">${dateLine}${timeLine}${locLine}</div>
        ${ev.note ? `<div style="font-size:0.75rem;color:var(--text3);margin-top:0.35rem;">ğŸ“ ${ev.note}</div>` : ''}
        ${currentUser ? `<div class="event-card-actions">
          <button class="btn-xs edit" onclick="openEditEvent('${ev.id}')">ç·¨è¼¯</button>
          <button class="btn-xs del" onclick="confirmDelete('${ev.id}')">åˆªé™¤</button>
        </div>` : ''}
      `;
      section.appendChild(card);
    });

    body.appendChild(section);
  });

  if(!hasAny){
    body.innerHTML = '<div class="no-events">é€™å¤©é‚„æ²’æœ‰ä»»ä½•æ´»å‹•</div>';
  }
}

window.closeDayModal = () => {
  document.getElementById('modal-day').classList.remove('open');
  dayModalDate = null;
};

window.addFromDayModal = () => {
  const d = dayModalDate;
  closeDayModal();
  openAddModal(d);
};

// â”€â”€ Add/Edit Modal â”€â”€
window.openAddModal = (dateStr) => {
  if(!currentUser) return;
  editingId = null;
  document.getElementById('modal-add-title').textContent = 'æ–°å¢æ´»å‹•';
  document.getElementById('ev-title').value = '';
  document.getElementById('ev-start').value = dateStr || '';
  document.getElementById('ev-end').value = dateStr || '';
  document.getElementById('ev-start-time').value = '';
  document.getElementById('ev-end-time').value = '';
  document.getElementById('ev-location').value = '';
  document.getElementById('ev-note').value = '';
  document.getElementById('btn-delete-ev').style.display = 'none';
  clearMsg('add-msg');
  document.getElementById('modal-add').classList.add('open');
};

window.openEditEvent = (id) => {
  const ev = events.find(e => e.id === id);
  if(!ev) return;
  editingId = id;
  document.getElementById('modal-add-title').textContent = 'ç·¨è¼¯æ´»å‹•';
  document.getElementById('ev-title').value = ev.title || '';
  document.getElementById('ev-start').value = ev.start || '';
  document.getElementById('ev-end').value = ev.end || ev.start || '';
  document.getElementById('ev-start-time').value = ev.startTime || '';
  document.getElementById('ev-end-time').value = ev.endTime || '';
  document.getElementById('ev-location').value = ev.location || '';
  document.getElementById('ev-dept').value = ev.dept || 'æ•™å‹™è™•';
  document.getElementById('ev-note').value = ev.note || '';
  document.getElementById('btn-delete-ev').style.display = '';
  clearMsg('add-msg');
  document.getElementById('modal-add').classList.add('open');
};

window.closeAddModal = () => { document.getElementById('modal-add').classList.remove('open'); editingId = null; };

window.handleSaveEvent = async () => {
  const title = document.getElementById('ev-title').value.trim();
  const start = document.getElementById('ev-start').value;
  const end = document.getElementById('ev-end').value || start;
  const startTime = document.getElementById('ev-start-time').value;
  const endTime = document.getElementById('ev-end-time').value;
  const location = document.getElementById('ev-location').value.trim();
  const dept = document.getElementById('ev-dept').value;
  const note = document.getElementById('ev-note').value.trim();

  if(!title) return showMsg('add-msg','error','è«‹å¡«å¯«æ´»å‹•åç¨±');
  if(!start) return showMsg('add-msg','error','è«‹é¸æ“‡é–‹å§‹æ—¥æœŸ');
  if(!end) return showMsg('add-msg','error','è«‹é¸æ“‡çµæŸæ—¥æœŸ');
  if(!location) return showMsg('add-msg','error','è«‹å¡«å¯«åœ°é»æˆ–æ•™å®¤');
  if(end < start) return showMsg('add-msg','error','çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ');

  const btn = document.getElementById('btn-save-ev');
  btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­â€¦';

  try {
    const payload = { title, start, end, startTime, endTime, location, dept, note, createdBy: currentUser.email, updatedAt: serverTimestamp() };
    if(editingId){
      await updateDoc(doc(db, COL, editingId), payload);
    } else {
      payload.createdAt = serverTimestamp();
      await addDoc(collection(db, COL), payload);
    }
    closeAddModal();
  } catch(e) {
    showMsg('add-msg','error',`å„²å­˜å¤±æ•—ï¼š${e.message}`);
  }
  btn.disabled = false; btn.textContent = 'å„²å­˜';
};

window.handleDeleteEvent = async () => {
  if(!editingId || !confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ´»å‹•å—ï¼Ÿ')) return;
  await deleteDoc(doc(db, COL, editingId));
  closeAddModal();
};

window.confirmDelete = async (id) => {
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ´»å‹•å—ï¼Ÿ')) return;
  await deleteDoc(doc(db, COL, id));
};

// â”€â”€ Login â”€â”€
window.openLoginModal = () => { clearMsg('login-msg'); document.getElementById('modal-login').classList.add('open'); };
window.closeLoginModal = () => document.getElementById('modal-login').classList.remove('open');

window.handleEmailLogin = async () => {
  const email = document.getElementById('login-email').value.trim();
  const pw = document.getElementById('login-password').value;
  if(!email||!pw) return showMsg('login-msg','error','è«‹å¡«å¯«å¸³è™Ÿå’Œå¯†ç¢¼');
  if(!email.endsWith('@'+DOMAIN)) return showMsg('login-msg','error',`åƒ…é™ @${DOMAIN} ä¿¡ç®±`);
  try {
    await signInWithEmailAndPassword(auth, email, pw);
  } catch(e) {
    const m = {'auth/invalid-credential':'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤','auth/too-many-requests':'å˜—è©¦å¤ªå¤šæ¬¡ï¼Œè«‹ç¨å¾Œå†è©¦','auth/user-not-found':'æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿ'};
    showMsg('login-msg','error', m[e.code]||`éŒ¯èª¤ï¼š${e.code}`);
  }
};

window.handleGoogleLogin = async () => {
  try {
    const r = await signInWithPopup(auth, gProvider);
    if(!r.user.email.endsWith('@'+DOMAIN)){
      await signOut(auth);
      showMsg('login-msg','error',`åƒ…é™ @${DOMAIN} ä¿¡ç®±`);
    }
  } catch(e) {
    if(e.code!=='auth/popup-closed-by-user') showMsg('login-msg','error','Google ç™»å…¥å¤±æ•—');
  }
};

window.handleForgotPassword = async () => {
  const email = document.getElementById('login-email').value.trim();
  if(!email) return showMsg('login-msg','error','è«‹å…ˆè¼¸å…¥é›»å­éƒµä»¶');
  try {
    await sendPasswordResetEmail(auth, email);
    showMsg('login-msg','success', `âœ“ é‡è¨­å¯†ç¢¼ä¿¡å·²å¯„å‡º`);
  } catch(e) { showMsg('login-msg','error','å¯„é€å¤±æ•—ï¼Œè«‹ç¢ºèªä¿¡ç®±'); }
};

window.handleLogout = () => signOut(auth);

// Close on overlay click
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if(e.target===o) o.classList.remove('open'); });
});
</script>
</body>
</html>
