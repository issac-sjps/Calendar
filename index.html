<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°èŠåœ‹å° å­¸æ ¡è¡Œäº‹æ›†</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@700;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f0f4f8;
      --surface: #fff;
      --surface2: #f8fafc;
      --border: #e2e8f0;
      --text: #1a202c;
      --text2: #4a5568;
      --text3: #a0aec0;
      --shadow: 0 1px 3px rgba(0,0,0,0.07), 0 4px 14px rgba(0,0,0,0.05);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.13);
      --æ•™å‹™è™•: #3b82f6; --æ•™å‹™è™•-light: #eff6ff; --æ•™å‹™è™•-text: #1d4ed8;
      --å­¸å‹™è™•: #10b981; --å­¸å‹™è™•-light: #f0fdf4; --å­¸å‹™è™•-text: #065f46;
      --è¼”å°è™•: #f59e0b; --è¼”å°è™•-light: #fffbeb; --è¼”å°è™•-text: #92400e;
      --ç¸½å‹™è™•: #8b5cf6; --ç¸½å‹™è™•-light: #f5f3ff; --ç¸½å‹™è™•-text: #5b21b6;
    }
    body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 0 1.25rem; display: flex; align-items: center;
      justify-content: space-between; height: 56px;
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06); flex-shrink: 0;
    }
    .header-left { display: flex; align-items: center; gap: 0.65rem; }
    .school-badge { background: #1a202c; color: #fff; font-family: 'Noto Serif TC', serif; font-weight: 900; font-size: 0.85rem; padding: 0.3rem 0.6rem; letter-spacing: 0.04em; }
    .school-title { font-family: 'Noto Serif TC', serif; font-weight: 700; font-size: 1rem; }
    .header-right { display: flex; align-items: center; gap: 0.65rem; }
    #user-info { font-size: 0.8rem; color: var(--text2); display: none; align-items: center; gap: 0.45rem; }
    .user-dept-pill { padding: 0.18rem 0.55rem; border-radius: 999px; font-size: 0.72rem; font-weight: 600; }
    .btn-sm { padding: 0.38rem 0.9rem; border-radius: 6px; font-family: 'Noto Sans TC', sans-serif; font-size: 0.82rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.14s; }
    .btn-primary { background: #1a202c; color: #fff; }
    .btn-primary:hover { background: #2d3748; }
    .btn-ghost { background: none; border: 1px solid var(--border) !important; color: var(--text2); }
    .btn-ghost:hover { border-color: #94a3b8 !important; color: var(--text); }
    /* Add event button in header - only shown when logged in */
    #btn-add-header { display: none; background: #1a202c; color: #fff; padding: 0.38rem 1rem; border-radius: 6px; font-family: 'Noto Sans TC', sans-serif; font-size: 0.82rem; font-weight: 500; cursor: pointer; border: none; transition: background 0.14s; }
    #btn-add-header:hover { background: #2d3748; }

    /* â”€â”€ Location Filter Bar â”€â”€ */
    .location-bar {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 0.6rem 1.25rem; display: flex; align-items: center;
      gap: 0.45rem; flex-wrap: wrap; position: sticky; top: 56px; z-index: 99; flex-shrink: 0;
    }
    .loc-label { font-size: 0.85rem; font-weight: 600; color: var(--text2); margin-right: 0.25rem; white-space: nowrap; }
    .filter-btn {
      padding: 0.32rem 0.85rem; border-radius: 999px; font-size: 0.82rem; font-weight: 500;
      border: 1.5px solid var(--border); background: var(--surface); color: var(--text2);
      cursor: pointer; transition: all 0.14s; white-space: nowrap;
      font-family: 'Noto Sans TC', sans-serif;
    }
    .filter-btn:hover { border-color: #94a3b8; color: var(--text); }
    .filter-btn.active { background: #1a202c; border-color: #1a202c; color: #fff; }

    /* â”€â”€ Body layout â”€â”€ */
    .body-wrap { display: flex; flex: 1; min-height: 0; overflow: hidden; }

    /* â”€â”€ Sidebar â”€â”€ */
    .sidebar {
      width: 120px; flex-shrink: 0;
      background: var(--surface); border-right: 1px solid var(--border);
      padding: 1rem 0.7rem; display: flex; flex-direction: column; gap: 0.45rem;
      overflow-y: auto;
    }
    .sidebar-label { font-size: 0.8rem; font-weight: 700; color: var(--text2); letter-spacing: 0.04em; margin-bottom: 0.2rem; padding-left: 0.25rem; }
    .dept-btn {
      width: 100%; padding: 0.55rem 0.65rem; border-radius: 8px;
      border: 1.5px solid var(--border); background: none;
      font-family: 'Noto Sans TC', sans-serif; font-size: 0.85rem; font-weight: 500;
      cursor: pointer; transition: all 0.14s; text-align: left;
      display: flex; align-items: center; gap: 0.45rem; color: var(--text2);
    }
    .d-dot { width: 9px; height: 9px; border-radius: 2px; flex-shrink: 0; }
    .dept-btn:hover { border-color: #94a3b8; color: var(--text); background: var(--surface2); }
    .dept-btn.active { border-color: transparent; color: #fff; }
    .dept-btn.active .d-dot { background: rgba(255,255,255,0.55) !important; }
    .dept-btn.active-all { background: #1a202c; border-color: #1a202c; }
    .dept-btn.active-æ•™å‹™è™• { background: var(--æ•™å‹™è™•); border-color: var(--æ•™å‹™è™•); }
    .dept-btn.active-å­¸å‹™è™• { background: var(--å­¸å‹™è™•); border-color: var(--å­¸å‹™è™•); }
    .dept-btn.active-è¼”å°è™• { background: var(--è¼”å°è™•); border-color: var(--è¼”å°è™•); }
    .dept-btn.active-ç¸½å‹™è™• { background: var(--ç¸½å‹™è™•); border-color: var(--ç¸½å‹™è™•); }
    .sidebar-divider { height: 1px; background: var(--border); margin: 0.2rem 0; }

    /* â”€â”€ Calendar area â”€â”€ */
    .cal-wrap { flex: 1; padding: 1.25rem; min-width: 0; overflow-y: auto; }
    .cal-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
    .cal-nav-center { display: flex; align-items: center; gap: 0.75rem; }
    .cal-month { font-family: 'Noto Serif TC', serif; font-size: 1.3rem; font-weight: 700; min-width: 148px; text-align: center; }
    .icon-btn { width: 34px; height: 34px; border-radius: 7px; border: 1px solid var(--border); background: var(--surface); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; color: var(--text2); transition: all 0.13s; }
    .icon-btn:hover { background: var(--bg); border-color: #94a3b8; color: var(--text); }
    .today-btn { padding: 0.35rem 0.8rem; border-radius: 6px; border: 1px solid var(--border); background: var(--surface); font-family: 'Noto Sans TC', sans-serif; font-size: 0.8rem; cursor: pointer; color: var(--text2); transition: all 0.13s; }
    .today-btn:hover { background: var(--bg); color: var(--text); }

    .cal-grid { background: var(--surface); border-radius: 10px; border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; }
    .cal-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); border-bottom: 1px solid var(--border); background: var(--surface2); }
    .cal-weekday { padding: 0.55rem; text-align: center; font-size: 0.78rem; font-weight: 600; color: var(--text3); }
    .cal-weekday:first-child { color: #ef4444; }
    .cal-weekday:last-child { color: #3b82f6; }
    .cal-days { display: grid; grid-template-columns: repeat(7, 1fr); }

    .cal-day {
      min-height: 112px; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border);
      padding: 0.3rem; position: relative; transition: background 0.1s;
    }
    .cal-day:nth-child(7n) { border-right: none; }
    .cal-day:nth-last-child(-n+7) { border-bottom: none; }
    .cal-day.other-month { background: var(--surface2); }
    .cal-day.other-month .day-num { color: var(--text3); }
    .cal-day.today .day-num { background: #1a202c; color: #fff; border-radius: 50%; }
    .cal-day.sunday .day-num { color: #ef4444; }
    .cal-day.saturday .day-num { color: #3b82f6; }

    /* Clicking cell opens day detail */
    .cal-day.clickable:not(.other-month):hover { background: #f0f7ff; cursor: pointer; }
    .cal-day.clickable:not(.other-month)::after { content: 'â—'; position: absolute; top: 3px; right: 5px; font-size: 0.5rem; color: var(--text3); opacity: 0; transition: opacity 0.13s; pointer-events: none; }
    .cal-day.clickable:not(.other-month):hover::after { opacity: 1; }

    /* Day number: always clickable to open day-detail */
    .day-num {
      font-size: 0.82rem; font-weight: 600; width: 26px; height: 26px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 0.2rem; border-radius: 50%; transition: background 0.1s;
      cursor: pointer; flex-shrink: 0;
    }
    .day-num:hover { background: #dbeafe !important; }
    .cal-day.today .day-num:hover { background: #374151 !important; }
    .cal-day.sunday .day-num:hover { background: #fee2e2 !important; }
    .cal-day.saturday .day-num:hover { background: #dbeafe !important; }

    .day-events { display: flex; flex-direction: column; gap: 2px; }
    .event-chip { border-radius: 3px; padding: 1px 5px; font-size: 0.67rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; transition: filter 0.1s; line-height: 1.55; }
    .event-chip:hover { filter: brightness(0.88); }
    .more-chip { font-size: 0.65rem; color: var(--text3); padding: 1px 3px; cursor: pointer; }

    /* Dept colors */
    .bg-æ•™å‹™è™• { background: var(--æ•™å‹™è™•); color: #fff; }
    .bg-å­¸å‹™è™• { background: var(--å­¸å‹™è™•); color: #fff; }
    .bg-è¼”å°è™• { background: var(--è¼”å°è™•); color: #fff; }
    .bg-ç¸½å‹™è™• { background: var(--ç¸½å‹™è™•); color: #fff; }
    .soft-æ•™å‹™è™• { background: var(--æ•™å‹™è™•-light); color: var(--æ•™å‹™è™•-text); }
    .soft-å­¸å‹™è™• { background: var(--å­¸å‹™è™•-light); color: var(--å­¸å‹™è™•-text); }
    .soft-è¼”å°è™• { background: var(--è¼”å°è™•-light); color: var(--è¼”å°è™•-text); }
    .soft-ç¸½å‹™è™• { background: var(--ç¸½å‹™è™•-light); color: var(--ç¸½å‹™è™•-text); }
    .dot-æ•™å‹™è™• { background: var(--æ•™å‹™è™•); }
    .dot-å­¸å‹™è™• { background: var(--å­¸å‹™è™•); }
    .dot-è¼”å°è™• { background: var(--è¼”å°è™•); }
    .dot-ç¸½å‹™è™• { background: var(--ç¸½å‹™è™•); }

    /* â”€â”€ Modals â”€â”€ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 200; padding: 1rem; backdrop-filter: blur(3px); }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--surface); border-radius: 14px; box-shadow: var(--shadow-lg); width: 100%; max-width: 480px; animation: mIn 0.2s cubic-bezier(0.16,1,0.3,1); overflow: hidden; }
    @keyframes mIn { from { opacity:0; transform:scale(0.94) translateY(10px); } to { opacity:1; transform:scale(1) translateY(0); } }
    .modal-header { padding: 1.1rem 1.4rem 0.9rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal-header h3 { font-size: 0.98rem; font-weight: 700; }
    .modal-close { width: 26px; height: 26px; border-radius: 5px; border: none; background: var(--bg); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: var(--text2); transition: background 0.1s; }
    .modal-close:hover { background: var(--border); }
    .modal-body { padding: 1.1rem 1.4rem; max-height: 68vh; overflow-y: auto; }
    .modal-footer { padding: 0.9rem 1.4rem; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 0.45rem; }
    .form-group { margin-bottom: 0.9rem; }
    .form-group label { display: block; font-size: 0.8rem; font-weight: 500; color: var(--text2); margin-bottom: 0.3rem; }
    .req { color: #ef4444; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 0.52rem 0.75rem; border: 1.5px solid var(--border);
      border-radius: 7px; font-family: 'Noto Sans TC', sans-serif; font-size: 0.88rem;
      color: var(--text); background: var(--surface); outline: none; transition: border-color 0.14s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #1a202c; }
    .form-group textarea { resize: vertical; min-height: 60px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.65rem; }
    .form-msg { font-size: 0.78rem; color: #ef4444; margin-top: 0.4rem; display: none; line-height: 1.5; }
    .form-msg.ok { color: #059669; }
    .btn-md { padding: 0.52rem 1.15rem; border-radius: 7px; font-family: 'Noto Sans TC', sans-serif; font-size: 0.85rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.14s; }
    .btn-md.p { background: #1a202c; color: #fff; } .btn-md.p:hover { background: #2d3748; }
    .btn-md.c { background: var(--bg); color: var(--text2); } .btn-md.c:hover { background: var(--border); }
    .btn-md.d { background: #fee2e2; color: #dc2626; } .btn-md.d:hover { background: #fecaca; }
    .btn-md:disabled { opacity: 0.5; cursor: not-allowed; }

    /* â”€â”€ Day Detail Modal â”€â”€ */
    .day-modal .modal { max-width: 580px; }
    .day-modal-hdr {
      padding: 1.1rem 1.4rem 0.9rem; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .day-modal-hdr h3 { font-family: 'Noto Serif TC', serif; font-size: 1.05rem; font-weight: 700; }

    /* 4-column dept grid */
    .dept-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      padding: 1.1rem 1.4rem;
    }
    .dept-col {
      border: 1.5px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .dept-col-header {
      display: flex; align-items: center; gap: 0.45rem;
      padding: 0.55rem 0.75rem;
      font-size: 0.82rem; font-weight: 700;
    }
    .dept-col-body { padding: 0.5rem 0.6rem; min-height: 60px; }
    .dept-ev-item {
      padding: 0.45rem 0.55rem; border-radius: 6px; margin-bottom: 0.35rem;
      background: var(--surface2); border: 1px solid var(--border);
    }
    .dept-ev-item:last-child { margin-bottom: 0; }
    .dept-ev-title { font-size: 0.82rem; font-weight: 600; margin-bottom: 0.2rem; }
    .dept-ev-meta { font-size: 0.7rem; color: var(--text2); display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .dept-ev-actions { display: flex; gap: 0.3rem; margin-top: 0.35rem; }
    .btn-xs { padding: 0.2rem 0.55rem; border-radius: 4px; font-size: 0.68rem; font-weight: 500; cursor: pointer; border: none; font-family: 'Noto Sans TC', sans-serif; transition: all 0.12s; }
    .btn-xs.e { background: #f1f5f9; color: var(--text2); } .btn-xs.e:hover { background: var(--border); }
    .btn-xs.d { background: #fee2e2; color: #dc2626; } .btn-xs.d:hover { background: #fecaca; }
    .dept-empty { font-size: 0.75rem; color: var(--text3); text-align: center; padding: 0.6rem 0; }
    .day-modal-footer { padding: 0.85rem 1.4rem; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: flex-end; gap: 0.45rem; }
    .add-day-btn { padding: 0.5rem 1.1rem; border-radius: 7px; background: #1a202c; color: #fff; border: none; font-family: 'Noto Sans TC', sans-serif; font-size: 0.82rem; font-weight: 500; cursor: pointer; display: none; transition: background 0.13s; }
    .add-day-btn:hover { background: #2d3748; }

    /* Login */
    .login-modal .modal { max-width: 370px; }

    /* Loading */
    .loading-overlay { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 300; flex-direction: column; gap: 0.85rem; }
    .spinner { width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--text); border-radius: 50%; animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 0.82rem; color: var(--text3); }

    @media (max-width: 720px) {
      .sidebar { width: 96px; }
      .dept-grid { grid-template-columns: 1fr; }
      .school-title { display: none; }
    }
    @media (max-width: 520px) {
      .sidebar { display: none; }
      .cal-day { min-height: 72px; }
    }
  </style>
</head>
<body>

<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text">è¼‰å…¥ä¸­â€¦</div>
</div>

<!-- Header -->
<header>
  <div class="header-left">
    <div class="school-badge">æ–°èŠåœ‹å°</div>
    <span class="school-title">å­¸æ ¡è¡Œäº‹æ›†</span>
  </div>
  <div class="header-right">
    <div id="user-info">
      <span id="user-dept-pill" class="user-dept-pill"></span>
      <span id="user-email-show" style="font-size:0.75rem;color:var(--text3)"></span>
    </div>
    <!-- Add event button - top right, only shown when logged in -->
    <button id="btn-add-header" onclick="openAddModal(null)">ï¼‹ æ–°å¢æ´»å‹•</button>
    <button class="btn-sm btn-ghost" id="btn-logout" style="display:none" onclick="handleLogout()">ç™»å‡º</button>
    <button class="btn-sm btn-primary" id="btn-login-open" onclick="openLoginModal()">æ•™è·å“¡ç™»å…¥</button>
  </div>
</header>

<!-- Location Filter Bar -->
<div class="location-bar" id="location-bar">
  <span class="loc-label">åœ°é»ï¼š</span>
</div>

<!-- Body -->
<div class="body-wrap">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-label">è™•å®¤ç¯©é¸</div>
    <button class="dept-btn active active-all" id="dbtn-all" onclick="setDeptFilter('all')">
      <span class="d-dot" style="background:#94a3b8"></span>å…¨éƒ¨
    </button>
    <button class="dept-btn" id="dbtn-æ•™å‹™è™•" onclick="setDeptFilter('æ•™å‹™è™•')">
      <span class="d-dot dot-æ•™å‹™è™•"></span>æ•™å‹™è™•
    </button>
    <button class="dept-btn" id="dbtn-å­¸å‹™è™•" onclick="setDeptFilter('å­¸å‹™è™•')">
      <span class="d-dot dot-å­¸å‹™è™•"></span>å­¸å‹™è™•
    </button>
    <button class="dept-btn" id="dbtn-è¼”å°è™•" onclick="setDeptFilter('è¼”å°è™•')">
      <span class="d-dot dot-è¼”å°è™•"></span>è¼”å°è™•
    </button>
    <button class="dept-btn" id="dbtn-ç¸½å‹™è™•" onclick="setDeptFilter('ç¸½å‹™è™•')">
      <span class="d-dot dot-ç¸½å‹™è™•"></span>ç¸½å‹™è™•
    </button>
  </div>

  <!-- Calendar -->
  <div class="cal-wrap">
    <div class="cal-nav">
      <div class="cal-nav-center">
        <button class="icon-btn" onclick="changeMonth(-1)">â€¹</button>
        <div class="cal-month" id="cal-month-label"></div>
        <button class="icon-btn" onclick="changeMonth(1)">â€º</button>
      </div>
      <button class="today-btn" onclick="goToday()">ä»Šå¤©</button>
    </div>
    <div class="cal-grid">
      <div class="cal-weekdays">
        <div class="cal-weekday">æ—¥</div><div class="cal-weekday">ä¸€</div>
        <div class="cal-weekday">äºŒ</div><div class="cal-weekday">ä¸‰</div>
        <div class="cal-weekday">å››</div><div class="cal-weekday">äº”</div>
        <div class="cal-weekday">å…­</div>
      </div>
      <div class="cal-days" id="cal-days"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ Day Detail Modal (4 dept columns) â”€â”€ -->
<div class="modal-overlay day-modal" id="modal-day">
  <div class="modal" style="max-width:620px">
    <div class="day-modal-hdr">
      <h3 id="day-hdr-title"></h3>
      <button class="modal-close" onclick="closeDayModal()">âœ•</button>
    </div>
    <div class="dept-grid" id="dept-grid"></div>
    <div class="day-modal-footer">
      <button class="add-day-btn" id="add-day-btn" onclick="addFromDay()">ï¼‹ æ–°å¢é€™å¤©çš„æ´»å‹•</button>
      <button class="btn-md c" onclick="closeDayModal()">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Add/Edit Modal â”€â”€ -->
<div class="modal-overlay" id="modal-add">
  <div class="modal">
    <div class="modal-header">
      <h3 id="add-modal-title">æ–°å¢æ´»å‹•</h3>
      <button class="modal-close" onclick="closeAddModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>æ´»å‹•åç¨± <span class="req">*</span></label>
        <input type="text" id="ev-title" placeholder="ä¾‹ï¼šæœŸä¸­è€ƒã€ç­è¦ªæœƒâ€¦">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>é–‹å§‹æ—¥æœŸ <span class="req">*</span></label>
          <input type="date" id="ev-start">
        </div>
        <div class="form-group">
          <label>çµæŸæ—¥æœŸ <span class="req">*</span></label>
          <input type="date" id="ev-end">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>é–‹å§‹æ™‚é–“</label>
          <input type="time" id="ev-stime">
        </div>
        <div class="form-group">
          <label>çµæŸæ™‚é–“</label>
          <input type="time" id="ev-etime">
        </div>
      </div>
      <div class="form-group">
        <label>åœ°é» / æ•™å®¤ <span class="req">*</span></label>
        <select id="ev-location">
          <option value="">è«‹é¸æ“‡åœ°é»</option>
          <option>1Få¤§ç©¿å ‚</option>
          <option>1Få°ç„é—œ</option>
          <option>1Féœæ€æ›¸è»’</option>
          <option>2Fæ ¡é•·å®¤æ—æœƒè­°å®¤</option>
          <option>3Fè¦–è½æ•™å®¤</option>
          <option>4Fåœ–æ›¸é¤¨</option>
          <option>5Fæ´»å‹•ä¸­å¿ƒ</option>
          <option>çƒå ´å—ä¸€ï¼ˆäºŒ.äº”.å…­å¹´ç´šï¼‰</option>
          <option>çƒå ´å—äºŒï¼ˆäºŒ.äº”.å…­å¹´ç´šï¼‰</option>
          <option>çƒå ´åŒ—ä¸€ï¼ˆä¸€.ä¸‰.å››å¹´ç´šï¼‰</option>
          <option>çƒå ´åŒ—äºŒï¼ˆä¸€.ä¸‰.å››å¹´ç´šï¼‰</option>
          <option>æ¡Œçƒæ•™å®¤</option>
          <option>4Fæ¨‚æ´»æ•™å®¤</option>
        </select>
      </div>
      <div class="form-group">
        <label>æ‰€å±¬è™•å®¤ <span class="req">*</span></label>
        <select id="ev-dept">
          <option value="æ•™å‹™è™•">æ•™å‹™è™•</option>
          <option value="å­¸å‹™è™•">å­¸å‹™è™•</option>
          <option value="è¼”å°è™•">è¼”å°è™•</option>
          <option value="ç¸½å‹™è™•">ç¸½å‹™è™•</option>
        </select>
      </div>
      <div class="form-group">
        <label>å‚™è¨»èªªæ˜</label>
        <textarea id="ev-note" placeholder="é¸å¡«ï¼Œå¯å¡«è¯çµ¡äººã€æ³¨æ„äº‹é …â€¦"></textarea>
      </div>
      <div class="form-msg" id="add-msg"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-md d" id="btn-del-ev" style="display:none" onclick="handleDeleteEvent()">åˆªé™¤</button>
      <div style="flex:1"></div>
      <button class="btn-md c" onclick="closeAddModal()">å–æ¶ˆ</button>
      <button class="btn-md p" id="btn-save-ev" onclick="handleSaveEvent()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Login Modal â”€â”€ -->
<div class="modal-overlay login-modal" id="modal-login">
  <div class="modal" style="max-width:370px">
    <div class="modal-header">
      <h3>æ•™è·å“¡ç™»å…¥</h3>
      <button class="modal-close" onclick="closeLoginModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <p style="font-size:0.82rem;color:var(--text3);margin-bottom:0.9rem;line-height:1.7;">
        åƒ…é™ <strong style="color:var(--text)">@sjps.kh.edu.tw</strong> ä¿¡ç®±ç™»å…¥<br>
        è¨ªå®¢å¯ç›´æ¥ç€è¦½è¡Œäº‹æ›†ï¼Œç„¡éœ€ç™»å…¥
      </p>
      <div class="form-group">
        <label>å­¸æ ¡é›»å­éƒµä»¶</label>
        <input type="email" id="login-email" placeholder="yourname@sjps.kh.edu.tw">
      </div>
      <div class="form-group">
        <label>å¯†ç¢¼</label>
        <input type="password" id="login-pw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <div class="form-msg" id="login-msg"></div>
    </div>
    <div class="modal-footer" style="flex-direction:column;align-items:stretch;gap:0.45rem;">
      <button class="btn-md p" onclick="handleEmailLogin()" style="width:100%;padding:0.6rem;text-align:center;">ç™»å…¥</button>
      <button onclick="handleGoogleLogin()" style="width:100%;padding:0.6rem;background:var(--surface2);border:1.5px solid var(--border);border-radius:7px;display:flex;align-items:center;justify-content:center;gap:0.5rem;cursor:pointer;font-family:'Noto Sans TC',sans-serif;font-size:0.85rem;transition:background 0.13s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='var(--surface2)'">
        <svg width="15" height="15" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
        ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
      </button>
      <div style="text-align:center;font-size:0.72rem;color:var(--text3);margin-top:0.2rem;">
        <a onclick="handleForgotPassword()" style="cursor:pointer;text-decoration:underline;color:var(--text3);">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider,
  sendPasswordResetEmail, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, updateDoc, deleteDoc,
  doc, query, orderBy, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyAhAduO-twiIX8kPUcXcwJDyuRCZT_GOZI",
  authDomain: "myproject-c52cb.firebaseapp.com",
  projectId: "myproject-c52cb",
  storageBucket: "myproject-c52cb.firebasestorage.app",
  messagingSenderId: "494432013878",
  appId: "1:494432013878:web:3c631ca98030600f915297"
});
const auth = getAuth(app);
const db = getFirestore(app);
const gProvider = new GoogleAuthProvider();
const DOMAIN = 'sjps.kh.edu.tw';
const COL = 'calendar_events';
const DEPTS = ['æ•™å‹™è™•','å­¸å‹™è™•','è¼”å°è™•','ç¸½å‹™è™•'];
const LOCATIONS = [
  '1Få¤§ç©¿å ‚','1Få°ç„é—œ','1Féœæ€æ›¸è»’','2Fæ ¡é•·å®¤æ—æœƒè­°å®¤',
  '3Fè¦–è½æ•™å®¤','4Fåœ–æ›¸é¤¨','5Fæ´»å‹•ä¸­å¿ƒ',
  'çƒå ´å—ä¸€ï¼ˆäºŒ.äº”.å…­å¹´ç´šï¼‰','çƒå ´å—äºŒï¼ˆäºŒ.äº”.å…­å¹´ç´šï¼‰',
  'çƒå ´åŒ—ä¸€ï¼ˆä¸€.ä¸‰.å››å¹´ç´šï¼‰','çƒå ´åŒ—äºŒï¼ˆä¸€.ä¸‰.å››å¹´ç´šï¼‰',
  'æ¡Œçƒæ•™å®¤','4Fæ¨‚æ´»æ•™å®¤'
];

let currentUser = null;
let curYear = new Date().getFullYear();
let curMonth = new Date().getMonth();
let events = [];
let deptFilter = 'all';
let locFilter = 'all';
let editingId = null;
let dayModalDate = null;

// â”€â”€ Build location bar (full text, no truncation) â”€â”€
(function initLocBar(){
  const bar = document.getElementById('location-bar');
  const allBtn = document.createElement('button');
  allBtn.className = 'filter-btn active';
  allBtn.id = 'locbtn-all';
  allBtn.textContent = 'å…¨éƒ¨';
  allBtn.onclick = () => setLocFilter('all');
  bar.appendChild(allBtn);
  LOCATIONS.forEach(loc => {
    const btn = document.createElement('button');
    btn.className = 'filter-btn';
    btn.id = 'locbtn-' + loc;
    btn.textContent = loc; // full text, no ellipsis
    btn.onclick = () => setLocFilter(loc);
    bar.appendChild(btn);
  });
})();

// â”€â”€ Filters â”€â”€
window.setDeptFilter = (dept) => {
  deptFilter = dept;
  ['all','æ•™å‹™è™•','å­¸å‹™è™•','è¼”å°è™•','ç¸½å‹™è™•'].forEach(d => {
    const btn = document.getElementById('dbtn-' + d);
    if(!btn) return;
    btn.className = 'dept-btn';
    if(d === dept) btn.className += ` active active-${d}`;
  });
  renderCalendar();
  if(dayModalDate) renderDeptGrid(dayModalDate);
};

window.setLocFilter = (loc) => {
  locFilter = loc;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  const el = document.getElementById(loc === 'all' ? 'locbtn-all' : 'locbtn-' + loc);
  if(el) el.classList.add('active');
  renderCalendar();
  if(dayModalDate) renderDeptGrid(dayModalDate);
};

function passesFilter(ev){
  if(deptFilter !== 'all' && ev.dept !== deptFilter) return false;
  if(locFilter !== 'all' && ev.location !== locFilter) return false;
  return true;
}

// â”€â”€ Auth â”€â”€
onAuthStateChanged(auth, user => {
  if(user){
    const domain = (user.email||'').split('@')[1];
    if(domain !== DOMAIN){ signOut(auth); showFMsg('login-msg','','åƒ…é™ @'+DOMAIN+' ä¿¡ç®±'); return; }
    currentUser = user;
    document.getElementById('user-info').style.display = 'flex';
    document.getElementById('user-email-show').textContent = user.email.split('@')[0];
    document.getElementById('btn-logout').style.display = '';
    document.getElementById('btn-login-open').style.display = 'none';
    document.getElementById('btn-add-header').style.display = '';
    closeLoginModal();
  } else {
    currentUser = null;
    document.getElementById('user-info').style.display = 'none';
    document.getElementById('btn-logout').style.display = 'none';
    document.getElementById('btn-login-open').style.display = '';
    document.getElementById('btn-add-header').style.display = 'none';
  }
  document.getElementById('loading').style.display = 'none';
  renderCalendar();
  if(dayModalDate) renderDeptGrid(dayModalDate);
});

// â”€â”€ Firestore â”€â”€
onSnapshot(query(collection(db, COL), orderBy('start')), snap => {
  events = snap.docs.map(d => ({id: d.id, ...d.data()}));
  renderCalendar();
  if(dayModalDate) renderDeptGrid(dayModalDate);
}, err => {
  console.error(err);
  document.getElementById('loading').style.display = 'none';
});

// â”€â”€ Calendar helpers â”€â”€
function pad(n){ return String(n).padStart(2,'0'); }
function ds(date){ return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`; }
function dowCh(n){ return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][n]; }

function renderCalendar(){
  document.getElementById('cal-month-label').textContent = `${curYear} å¹´ ${curMonth+1} æœˆ`;
  const firstDow = new Date(curYear, curMonth, 1).getDay();
  const daysInMonth = new Date(curYear, curMonth+1, 0).getDate();
  const prevTotal = new Date(curYear, curMonth, 0).getDate();
  const today = new Date();
  const container = document.getElementById('cal-days');
  container.innerHTML = '';

  for(let i = firstDow-1; i >= 0; i--)
    container.appendChild(makeCell(new Date(curYear, curMonth-1, prevTotal-i), true));
  for(let d = 1; d <= daysInMonth; d++){
    const isToday = today.getFullYear()===curYear && today.getMonth()===curMonth && today.getDate()===d;
    container.appendChild(makeCell(new Date(curYear, curMonth, d), false, isToday));
  }
  const total = firstDow + daysInMonth;
  const rem = total%7===0 ? 0 : 7-(total%7);
  for(let d=1; d<=rem; d++)
    container.appendChild(makeCell(new Date(curYear, curMonth+1, d), true));
}

function makeCell(date, otherMonth, isToday=false){
  const dateStr = ds(date);
  const dow = date.getDay();
  const cell = document.createElement('div');
  cell.className = 'cal-day'
    +(otherMonth?' other-month':'')
    +(isToday?' today':'')
    +(!otherMonth&&dow===0?' sunday':'')
    +(!otherMonth&&dow===6?' saturday':'')
    +(!otherMonth?' clickable':'');

  // Day number â†’ open day detail modal
  const numEl = document.createElement('div');
  numEl.className = 'day-num';
  numEl.textContent = date.getDate();
  numEl.onclick = e => { e.stopPropagation(); openDayModal(dateStr); };
  cell.appendChild(numEl);

  // Event chips
  const dayEvs = events.filter(ev => {
    if(!passesFilter(ev)) return false;
    const end = ev.end||ev.start;
    return dateStr >= ev.start && dateStr <= end;
  });
  const evWrap = document.createElement('div');
  evWrap.className = 'day-events';
  const MAX = 3;
  dayEvs.slice(0,MAX).forEach(ev => {
    const chip = document.createElement('div');
    chip.className = `event-chip bg-${ev.dept}`;
    chip.textContent = ev.title;
    chip.title = ev.title + (ev.location?' @ '+ev.location:'');
    chip.onclick = e => { e.stopPropagation(); openDayModal(dateStr); };
    evWrap.appendChild(chip);
  });
  if(dayEvs.length > MAX){
    const more = document.createElement('div');
    more.className = 'more-chip';
    more.textContent = `é‚„æœ‰ ${dayEvs.length-MAX} å€‹`;
    more.onclick = e => { e.stopPropagation(); openDayModal(dateStr); };
    evWrap.appendChild(more);
  }
  cell.appendChild(evWrap);

  // Click cell BG â†’ open day detail modal (everyone)
  if(!otherMonth)
    cell.onclick = () => openDayModal(dateStr);

  return cell;
}

window.changeMonth = d => {
  curMonth += d;
  if(curMonth<0){curMonth=11;curYear--;} if(curMonth>11){curMonth=0;curYear++;}
  renderCalendar();
};
window.goToday = () => { curYear=new Date().getFullYear(); curMonth=new Date().getMonth(); renderCalendar(); };

// â”€â”€ Day Modal â”€â”€
window.openDayModal = (dateStr) => {
  dayModalDate = dateStr;
  const d = new Date(dateStr);
  document.getElementById('day-hdr-title').textContent =
    `${d.getFullYear()} å¹´ ${d.getMonth()+1} æœˆ ${d.getDate()} æ—¥ï¼ˆ${dowCh(d.getDay())}ï¼‰`;
  renderDeptGrid(dateStr);
  document.getElementById('add-day-btn').style.display = currentUser ? 'inline-flex' : 'none';
  document.getElementById('modal-day').classList.add('open');
};

function renderDeptGrid(dateStr){
  const grid = document.getElementById('dept-grid');
  grid.innerHTML = '';
  // Get all events on this date (no filter applied â€” show all 4 depts always in the 4-col view)
  const dayEvs = events.filter(ev => {
    const end = ev.end||ev.start;
    return dateStr >= ev.start && dateStr <= end;
  });

  DEPTS.forEach(dept => {
    const col = document.createElement('div');
    col.className = 'dept-col';

    const hdr = document.createElement('div');
    hdr.className = `dept-col-header soft-${dept}`;
    hdr.innerHTML = `<span class="d-dot dot-${dept}"></span>${dept}`;
    col.appendChild(hdr);

    const body = document.createElement('div');
    body.className = 'dept-col-body';

    const dEvs = dayEvs.filter(e => e.dept === dept);
    if(dEvs.length === 0){
      body.innerHTML = '<div class="dept-empty">â€”</div>';
    } else {
      dEvs.forEach(ev => {
        const item = document.createElement('div');
        item.className = 'dept-ev-item';
        const dateRange = ev.end&&ev.end!==ev.start ? `${ev.start}ï½${ev.end}` : ev.start;
        const timeStr = (ev.stime||ev.etime) ? `ğŸ• ${ev.stime||''}${ev.etime?' â€“ '+ev.etime:''}` : '';
        item.innerHTML = `
          <div class="dept-ev-title">${ev.title}</div>
          <div class="dept-ev-meta">
            <span>ğŸ“… ${dateRange}</span>
            ${timeStr?`<span>${timeStr}</span>`:''}
            ${ev.location?`<span>ğŸ“ ${ev.location}</span>`:''}
          </div>
          ${ev.note?`<div style="font-size:0.68rem;color:var(--text3);margin-top:0.22rem;">ğŸ“ ${ev.note}</div>`:''}
          ${currentUser?`<div class="dept-ev-actions">
            <button class="btn-xs e" onclick="openEditEvent('${ev.id}')">ç·¨è¼¯</button>
            <button class="btn-xs d" onclick="confirmDelete('${ev.id}')">åˆªé™¤</button>
          </div>`:''}
        `;
        body.appendChild(item);
      });
    }
    col.appendChild(body);
    grid.appendChild(col);
  });
}

window.closeDayModal = () => { document.getElementById('modal-day').classList.remove('open'); dayModalDate=null; };
window.addFromDay = () => { const d=dayModalDate; closeDayModal(); openAddModal(d); };

// â”€â”€ Add/Edit Modal â”€â”€
window.openAddModal = (dateStr) => {
  if(!currentUser) return;
  editingId = null;
  document.getElementById('add-modal-title').textContent = 'æ–°å¢æ´»å‹•';
  document.getElementById('ev-title').value = '';
  document.getElementById('ev-start').value = dateStr||'';
  document.getElementById('ev-end').value = dateStr||'';
  document.getElementById('ev-stime').value = '';
  document.getElementById('ev-etime').value = '';
  document.getElementById('ev-location').value = '';
  document.getElementById('ev-dept').value = 'æ•™å‹™è™•';
  document.getElementById('ev-note').value = '';
  document.getElementById('btn-del-ev').style.display = 'none';
  clearFMsg('add-msg');
  document.getElementById('modal-add').classList.add('open');
};

window.openEditEvent = (id) => {
  const ev = events.find(e=>e.id===id);
  if(!ev||!currentUser) return;
  editingId = id;
  document.getElementById('add-modal-title').textContent = 'ç·¨è¼¯æ´»å‹•';
  document.getElementById('ev-title').value = ev.title||'';
  document.getElementById('ev-start').value = ev.start||'';
  document.getElementById('ev-end').value = ev.end||ev.start||'';
  document.getElementById('ev-stime').value = ev.stime||'';
  document.getElementById('ev-etime').value = ev.etime||'';
  document.getElementById('ev-location').value = ev.location||'';
  document.getElementById('ev-dept').value = ev.dept||'æ•™å‹™è™•';
  document.getElementById('ev-note').value = ev.note||'';
  document.getElementById('btn-del-ev').style.display = '';
  clearFMsg('add-msg');
  document.getElementById('modal-add').classList.add('open');
};

window.closeAddModal = () => { document.getElementById('modal-add').classList.remove('open'); editingId=null; };

window.handleSaveEvent = async () => {
  const title = document.getElementById('ev-title').value.trim();
  const start = document.getElementById('ev-start').value;
  const end = document.getElementById('ev-end').value||start;
  const stime = document.getElementById('ev-stime').value;
  const etime = document.getElementById('ev-etime').value;
  const location = document.getElementById('ev-location').value;
  const dept = document.getElementById('ev-dept').value;
  const note = document.getElementById('ev-note').value.trim();

  if(!title) return showFMsg('add-msg','','è«‹å¡«å¯«æ´»å‹•åç¨±');
  if(!start) return showFMsg('add-msg','','è«‹é¸æ“‡é–‹å§‹æ—¥æœŸ');
  if(!end) return showFMsg('add-msg','','è«‹é¸æ“‡çµæŸæ—¥æœŸ');
  if(!location) return showFMsg('add-msg','','è«‹é¸æ“‡åœ°é»æˆ–æ•™å®¤');
  if(end < start) return showFMsg('add-msg','','çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ');

  const btn = document.getElementById('btn-save-ev');
  btn.disabled=true; btn.textContent='å„²å­˜ä¸­â€¦';
  try {
    const payload = {title,start,end,stime,etime,location,dept,note,createdBy:currentUser.email,updatedAt:serverTimestamp()};
    if(editingId){ await updateDoc(doc(db,COL,editingId),payload); }
    else { payload.createdAt=serverTimestamp(); await addDoc(collection(db,COL),payload); }
    closeAddModal();
  } catch(e){ showFMsg('add-msg','','å„²å­˜å¤±æ•—ï¼š'+e.message); }
  btn.disabled=false; btn.textContent='å„²å­˜';
};

window.handleDeleteEvent = async () => {
  if(!editingId||!confirm('ç¢ºå®šåˆªé™¤é€™å€‹æ´»å‹•ï¼Ÿ')) return;
  await deleteDoc(doc(db,COL,editingId));
  closeAddModal();
};

window.confirmDelete = async (id) => {
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ´»å‹•å—ï¼Ÿ')) return;
  await deleteDoc(doc(db,COL,id));
};

// â”€â”€ Login â”€â”€
function showFMsg(id, cls, text){ const el=document.getElementById(id); el.className='form-msg '+cls; el.textContent=text; el.style.display='block'; }
function clearFMsg(id){ const el=document.getElementById(id); el.style.display='none'; el.textContent=''; }

window.openLoginModal = () => { clearFMsg('login-msg'); document.getElementById('modal-login').classList.add('open'); };
window.closeLoginModal = () => document.getElementById('modal-login').classList.remove('open');

window.handleEmailLogin = async () => {
  const email=document.getElementById('login-email').value.trim();
  const pw=document.getElementById('login-pw').value;
  if(!email||!pw) return showFMsg('login-msg','','è«‹å¡«å¯«å¸³è™Ÿå’Œå¯†ç¢¼');
  if(!email.endsWith('@'+DOMAIN)) return showFMsg('login-msg','','åƒ…é™ @'+DOMAIN+' ä¿¡ç®±');
  try { await signInWithEmailAndPassword(auth,email,pw); }
  catch(e){
    const m={'auth/invalid-credential':'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤','auth/too-many-requests':'å˜—è©¦å¤ªå¤šæ¬¡ï¼Œè«‹ç¨å¾Œå†è©¦','auth/user-not-found':'æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿ'};
    showFMsg('login-msg','',m[e.code]||'éŒ¯èª¤ï¼š'+e.code);
  }
};

window.handleGoogleLogin = async () => {
  try {
    const r=await signInWithPopup(auth,gProvider);
    if(!r.user.email.endsWith('@'+DOMAIN)){ await signOut(auth); showFMsg('login-msg','','åƒ…é™ @'+DOMAIN+' ä¿¡ç®±'); }
  } catch(e){ if(e.code!=='auth/popup-closed-by-user') showFMsg('login-msg','','Google ç™»å…¥å¤±æ•—'); }
};

window.handleForgotPassword = async () => {
  const email=document.getElementById('login-email').value.trim();
  if(!email) return showFMsg('login-msg','','è«‹å…ˆè¼¸å…¥é›»å­éƒµä»¶');
  try { await sendPasswordResetEmail(auth,email); showFMsg('login-msg','ok','âœ“ é‡è¨­å¯†ç¢¼ä¿¡å·²å¯„å‡º'); }
  catch(e){ showFMsg('login-msg','','å¯„é€å¤±æ•—ï¼Œè«‹ç¢ºèªä¿¡ç®±'); }
};

window.handleLogout = () => signOut(auth);

document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if(e.target===o) o.classList.remove('open'); });
});
</script>
</body>
</html>
